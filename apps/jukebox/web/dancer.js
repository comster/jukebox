/*
 * Dancer.js (c) 2012 Jordan Santell
 * MIT License
 * http://github.com/jsantell/dancer.js
 *
 * v0.2.1
 */
function FourierTransform(a,b){this.bufferSize=a,this.sampleRate=b,this.bandwidth=2/a*b/2,this.spectrum=new Float32Array(a/2),this.real=new Float32Array(a),this.imag=new Float32Array(a),this.peakBand=0,this.peak=0,this.getBandFrequency=function(a){return this.bandwidth*a+this.bandwidth/2},this.calculateSpectrum=function(){var b=this.spectrum,c=this.real,d=this.imag,e=2/this.bufferSize,f=Math.sqrt,g,h,i;for(var j=0,k=a/2;j<k;j++)g=c[j],h=d[j],i=e*f(g*g+h*h),i>this.peak&&(this.peakBand=j,this.peak=i),b[j]=i}}function FFT(a,b){FourierTransform.call(this,a,b),this.reverseTable=new Uint32Array(a);var c=1,d=a>>1,e;while(c<a){for(e=0;e<c;e++)this.reverseTable[e+c]=this.reverseTable[e]+d;c<<=1,d>>=1}this.sinTable=new Float32Array(a),this.cosTable=new Float32Array(a);for(e=0;e<a;e++)this.sinTable[e]=Math.sin(-Math.PI/e),this.cosTable[e]=Math.cos(-Math.PI/e)}(function(){function b(){for(var a in this.sections)this.sections[a].condition()&&this.sections[a].callback.call(this)}var a=function(c,d){this.audioAdapter=a._getAdapter(this),this.events={},this.sections=[],this.bind("update",b),this.source=a._makeSupportedPath(c,d),this.audioAdapter.load(this.source)};a.adapters={},a.prototype={play:function(){return this.audioAdapter.play(),this},stop:function(){return this.audioAdapter.stop(),this},createBeat:function(b,c,d,e,f){return new a.Beat(this,b,c,d,e,f)},bind:function(a,b){return this.events[a]||(this.events[a]=[]),this.events[a].push(b),this},unbind:function(a){return this.events[a]&&delete this.events[a],this},trigger:function(a){var b=this;return this.events[a]&&this.events[a].forEach(function(a){a.call(b)}),this},getTime:function(){return this.audioAdapter.getTime()},getFrequency:function(a,b){var c=0;if(b!==undefined){for(var d=a;d<=b;d++)c+=this.getSpectrum()[d];return c/(b-a+1)}return this.getSpectrum()[a]},getWaveform:function(){return this.audioAdapter.getWaveform()},getSpectrum:function(){return this.audioAdapter.getSpectrum()},isLoaded:function(){return this.audioAdapter.isLoaded},isPlaying:function(){return this.audioAdapter.isPlaying},after:function(a,b){var c=this;return this.sections.push({condition:function(){return c.getTime()>a},callback:b}),this},before:function(a,b){var c=this;return this.sections.push({condition:function(){return c.getTime()<a},callback:b}),this},between:function(a,b,c){var d=this;return this.sections.push({condition:function(){return d.getTime()>a&&d.getTime()<b},callback:c}),this},onceAt:function(a,b){var c=this,d=null;return this.sections.push({condition:function(){return c.getTime()>a&&!this.called},callback:function(){b.call(this),d.called=!0},called:!1}),d=this.sections[this.sections.length-1],this}},window.Dancer=a})(),function(a){var b={mp3:"audio/mpeg;",ogg:'audio/ogg; codecs="vorbis"',wav:'audio/wav; codecs="1"',aac:'audio/mp4; codecs="mp4a.40.2"'},c=document.createElement("audio");a.options={},a.setOptions=function(b){for(var c in b)b.hasOwnProperty(c)&&(a.options[c]=b[c])},a.isSupported=function(){return!window.Float32Array||!window.Uint32Array?null:window.AudioContext||window.webkitAudioContext?"webaudio":window.Audio&&(new window.Audio).mozSetup?"audiodata":FlashDetect.versionAtLeast(9)?"flash":""},a.canPlay=function(d){var e=c.canPlayType;return a.isSupported()==="flash"?d.toLowerCase()==="mp3":!!c.canPlayType&&!!c.canPlayType(b[d.toLowerCase()]).replace(/no/,"")},a.addPlugin=function(b,c){a.prototype[b]===undefined&&(a.prototype[b]=c)},a._makeSupportedPath=function(b,c){if(!c)return b;for(var d=0;d<c.length;d++)if(a.canPlay(c[d]))return b+"."+c[d];return b},a._getAdapter=function(b){switch(a.isSupported()){case"webaudio":return new a.adapters.webkit(b);case"audiodata":return new a.adapters.moz(b);case"flash":return new a.adapters.flash(b);default:return null}}}(window.Dancer),function(){var a=function(a,b){b=b||{},this.dancer=a,this.frequency=b.frequency||[0,10],this.threshold=b.threshold||.3,this.decay=b.decay||.02,this.onBeat=b.onBeat,this.offBeat=b.offBeat,this.isOn=!1,this.currentThreshold=this.threshold;var c=this;this.dancer.bind("update",function(){c.onUpdate()})};a.prototype={on:function(){return this.isOn=!0,this},off:function(){return this.isOn=!1,this},onUpdate:function(){if(!this.isOn)return;var a=this.maxAmplitude(this.frequency);a>=this.currentThreshold&&a>=this.threshold?(this.currentThreshold=a,this.onBeat&&this.onBeat.call(this.dancer,a)):(this.offBeat&&this.offBeat.call(this.dancer,a),this.currentThreshold-=this.decay)},maxAmplitude:function(a){var b=0,c=this.dancer.getSpectrum();if(!a.length)return a<c.length?c[~~a]:null;for(var d=a[0],e=a[1];d<=e;d++)c[d]>b&&(b=c[d]);return b}},window.Dancer.Beat=a}(),function(){function d(){this.source=this.context.createBufferSource(),this.source.buffer=this.buffer,this.source.connect(this.context.destination),this.source.connect(this.proc),this.source.connect(this.context.destination)}var a=2048,b=44100,c=function(a){this.dancer=a,this.context=window.AudioContext?new window.AudioContext:new window.webkitAudioContext,this.isLoaded=!1,this.isPlaying=!1,this.isDisconnected=!1};c.prototype={load:function(c){var e=new XMLHttpRequest,f=this;e.open("GET",c,!0),e.responseType="arraybuffer",e.onload=function(){f.context.decodeAudioData?f.context.decodeAudioData(e.response,function(a){f.buffer=a,d.call(f),f.isLoaded=!0,f.dancer.trigger("loaded")},function(a){console.log(a)}):(f.buffer=f.context.createBuffer(e.response,!1),d.call(f),f.isLoaded=!0,f.dancer.trigger("loaded"))},e.send(),this.proc=this.context.createJavaScriptNode(a/2,1,1),this.proc.onaudioprocess=function(a){f.update.call(f,a)},this.proc.connect(this.context.destination),this.fft=new FFT(a/2,b),this.signal=new Float32Array(a/2)},play:function(){function b(){a.isDisconnected&&d.call(a),a.source.noteOn(0),a.startTime=a.context.currentTime,a.isPlaying=!0}var a=this;this.isLoaded?b():this.dancer.bind("loaded",b)},stop:function(){this.isPlaying&&(this.source.noteOff(0),this.isDisconnected=!0,this.endTime=this.getTime()),this.isPlaying=!1},getWaveform:function(){return this.signal},getSpectrum:function(){return this.fft.spectrum},getTime:function(){return this.isPlaying?this.context.currentTime-(this.startTime||0):this.endTime||0},update:function(b){if(!this.isPlaying)return;var c=[],d=b.inputBuffer.numberOfChannels,e=a/d,f;for(f=d;f--;)c.push(b.inputBuffer.getChannelData(f));for(f=0;f<e;f++)this.signal[f]=d>1?c.reduce(function(a,b){return a[f]+b[f]})/d:c[0][f];this.fft.forward(this.signal),this.dancer.trigger("update")}},Dancer.adapters.webkit=c}(),function(){var a=function(a){this.dancer=a,this.audio=new Audio,this.isLoaded=this.isPlaying=!1};a.prototype={load:function(a){var b=this;this.audio.src=a,this.audio.addEventListener("loadedmetadata",function(a){b.fbLength=b.audio.mozFrameBufferLength,b.channels=b.audio.mozChannels,b.rate=b.audio.mozSampleRate,b.fft=new FFT(b.fbLength/b.channels,b.rate),b.signal=new Float32Array(b.fbLength/b.channels),b.isLoaded=!0,b.dancer.trigger("loaded")},!1),this.audio.addEventListener("MozAudioAvailable",function(a){b.update(a)},!1)},play:function(){this.audio.play(),this.isPlaying=!0},stop:function(){this.audio.pause(),this.isPlaying=!1},getWaveform:function(){return this.signal},getSpectrum:function(){return this.fft.spectrum},getTime:function(){return this.audio.currentTime},update:function(a){if(!this.isLoaded)return;for(var b=0,c=this.fbLength/2;b<c;b++)this.signal[b]=(a.frameBuffer[2*b]+a.frameBuffer[2*b+1])/2;this.fft.forward(this.signal),this.dancer.trigger("update")}},Dancer.adapters.moz=a}(),function(){function g(){var a=this;d=!0,h(Dancer.options.flashJS,function(){soundManager=new SoundManager,soundManager.flashVersion=9,soundManager.flash9Options.useWaveformData=!0,soundManager.useWaveformData=!0,soundManager.useHighPerformance=!0,soundManager.useFastPolling=!0,soundManager.multiShot=!1,soundManager.debugMode=!1,soundManager.debugFlash=!1,soundManager.url=Dancer.options.flashSWF,soundManager.onready(function(){c=!0,a.load()}),soundManager.ontimeout(function(){console.error("Error loading SoundManager2.swf")}),soundManager.beginDelayedInit()})}function h(a,b){var c=document.createElement("script"),d=document.getElementsByTagName("script")[0];c.type="text/javascript",c.src=a,c.onload=b,d.parentNode.insertBefore(c,d)}var a=1024,b=44100,c=!1,d=!1,e=.93,f=function(a){this.dancer=a,this.isLoaded=this.isPlaying=!1,this.wave_L=[],this.wave_R=[],this.spectrum=[],window.SM2_DEFER=!0};f.prototype={load:function(c){var e=this;this.path=c||this.path,!window.soundManager&&!d&&g.call(this),window.soundManager&&(this.audio=soundManager.createSound({id:"dancer"+Math.random()+"",url:this.path,stream:!0,autoPlay:!1,autoLoad:!0,whileplaying:function(){e.update()},onload:function(){e.fft=new FFT(a,b),e.signal=new Float32Array(a),e.waveform=new Float32Array(a),e.isLoaded=!0,e.dancer.trigger("loaded")}}))},play:function(){!this.isPlaying&&this.isLoaded&&(this.audio.play(),this.isPlaying=!0)},stop:function(){this.audio.stop(),this.isPlaying=!1},getWaveform:function(){return this.waveform},getSpectrum:function(){return this.fft.spectrum},getTime:function(){return this.audio.position/1e3},update:function(){if(!this.isLoaded)return;this.wave_L=this.audio.waveformData.left,this.wave_R=this.audio.waveformData.right;var a;for(var b=0,c=this.wave_L.length;b<c;b++)a=parseFloat(this.wave_L[b])+parseFloat(this.wave_R[b]),this.waveform[2*b]=a/2,this.waveform[b*2+1]=a/2,this.signal[2*b]=a*e,this.signal[b*2+1]=a*e;this.fft.forward(this.signal),this.dancer.trigger("update")}},Dancer.adapters.flash=f}(),FFT.prototype.forward=function(a){var b=this.bufferSize,c=this.cosTable,d=this.sinTable,e=this.reverseTable,f=this.real,g=this.imag,h=this.spectrum,i=Math.floor(Math.log(b)/Math.LN2);if(Math.pow(2,i)!==b)throw"Invalid buffer size, must be a power of 2.";if(b!==a.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+b+" Buffer Size: "+a.length;var j=1,k,l,m,n,o,p,q,r,s;for(s=0;s<b;s++)f[s]=a[e[s]],g[s]=0;while(j<b){k=c[j],l=d[j],m=1,n=0;for(var t=0;t<j;t++){s=t;while(s<b)o=s+j,p=m*f[o]-n*g[o],q=m*g[o]+n*f[o],f[o]=f[s]-p,g[o]=g[s]-q,f[s]+=p,g[s]+=q,s+=j<<1;r=m,m=r*k-n*l,n=r*l+n*k}j<<=1}return this.calculateSpectrum()};var FlashDetect=new function(){var a=this;a.installed=!1,a.raw="",a.major=-1,a.minor=-1,a.revision=-1,a.revisionStr="";var b=[{name:"ShockwaveFlash.ShockwaveFlash.7",version:function(a){return c(a)}},{name:"ShockwaveFlash.ShockwaveFlash.6",version:function(a){var b="6,0,21";try{a.AllowScriptAccess="always",b=c(a)}catch(d){}return b}},{name:"ShockwaveFlash.ShockwaveFlash",version:function(a){return c(a)}}],c=function(a){var b=-1;try{b=a.GetVariable("$version")}catch(c){}return b},d=function(a){var b=-1;try{b=new ActiveXObject(a)}catch(c){b={activeXError:!0}}return b},e=function(a){var b=a.split(",");return{raw:a,major:parseInt(b[0].split(" ")[1],10),minor:parseInt(b[1],10),revision:parseInt(b[2],10),revisionStr:b[2]}},f=function(a){var b=a.split(/ +/),c=b[2].split(/\./),d=b[3];return{raw:a,major:parseInt(c[0],10),minor:parseInt(c[1],10),revisionStr:d,revision:g(d)}},g=function(b){return parseInt(b.replace(/[a-zA-Z]/g,""),10)||a.revision};a.majorAtLeast=function(b){return a.major>=b},a.minorAtLeast=function(b){return a.minor>=b},a.revisionAtLeast=function(b){return a.revision>=b},a.versionAtLeast=function(b){var c=[a.major,a.minor,a.revision],d=Math.min(c.length,arguments.length);for(i=0;i<d;i++){if(c[i]>=arguments[i]){if(i+1<d&&c[i]==arguments[i])continue;return!0}return!1}},a.FlashDetect=function(){if(navigator.plugins&&navigator.plugins.length>0){var c="application/x-shockwave-flash",g=navigator.mimeTypes;if(g&&g[c]&&g[c].enabledPlugin&&g[c].enabledPlugin.description){var h=g[c].enabledPlugin.description,i=f(h);a.raw=i.raw,a.major=i.major,a.minor=i.minor,a.revisionStr=i.revisionStr,a.revision=i.revision,a.installed=!0}}else if(navigator.appVersion.indexOf("Mac")==-1&&window.execScript){var h=-1;for(var j=0;j<b.length&&h==-1;j++){var k=d(b[j].name);if(!k.activeXError){a.installed=!0,h=b[j].version(k);if(h!=-1){var i=e(h);a.raw=i.raw,a.major=i.major,a.minor=i.minor,a.revision=i.revision,a.revisionStr=i.revisionStr}}}}}()};FlashDetect.JS_RELEASE="1.0.4"

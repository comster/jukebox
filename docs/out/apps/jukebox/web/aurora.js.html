<!DOCTYPE html><html><head><title>aurora.js</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../../index.html" class="source"><span class="file_name">README</span></a><a href="../../../apps/jukebox/web/moment.min.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">moment.min.js</span></a><a href="../../../apps/jukebox/web/backbone.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">backbone.js</span></a><a href="../../../apps/jukebox/web/chat.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">chat.js</span></a><a href="../../../apps/jukebox/web/mp3.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">mp3.js</span></a><a href="../../../apps/jukebox/web/jsmad.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">jsmad.js</span></a><a href="../../../apps/jukebox/web/require.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">require.js</span></a><a href="../../../apps/jukebox/web/houseChat.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">houseChat.js</span></a><a href="../../../apps/jukebox/web/houseAuth.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">houseAuth.js</span></a><a href="../../../apps/jukebox/web/houseUsers.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">houseUsers.js</span></a><a href="../../../apps/jukebox/web/jukebox.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">jukebox.js</span></a><a href="../../../apps/jukebox/web/jquery.idle-timer.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">jquery.idle-timer.js</span></a><a href="../../../apps/jukebox/web/aac.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">aac.js</span></a><a href="../../../apps/jukebox/web/aurora.js.html" class="source selected"><span class="base_path">apps / jukebox / web / </span><span class="file_name">aurora.js</span></a><a href="../../../apps/jukebox/web/jquery.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">jquery.js</span></a><a href="../../../apps/jukebox/web/houseSongs.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">houseSongs.js</span></a><a href="../../../apps/jukebox/web/jquery.ui.min.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">jquery.ui.min.js</span></a><a href="../../../apps/jukebox/web/chart.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">chart.js</span></a><a href="../../../apps/jukebox/web/backbone-house.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">backbone-house.js</span></a><a href="../../../apps/jukebox/web/alac.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">alac.js</span></a><a href="../../../apps/jukebox/web/underscore.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">underscore.js</span></a><a href="../../../apps/jukebox/web/pitch.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">pitch.js</span></a><a href="../../../apps/jukebox/web/flac.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">flac.js</span></a><a href="../../../apps/jukebox/web/id3v2.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">id3v2.js</span></a><a href="../../../apps/jukebox/web/index.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">index.js</span></a><a href="../../../apps/jukebox/config/config.js.html" class="source "><span class="base_path">apps / jukebox / config / </span><span class="file_name">config.js</span></a><a href="../../../apps/jukebox/index.js.html" class="source "><span class="base_path">apps / jukebox / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/songs/index.js.html" class="source "><span class="base_path">endPoints / songs / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/apps/index.js.html" class="source "><span class="base_path">endPoints / apps / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/files/index.js.html" class="source "><span class="base_path">endPoints / files / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/auth/index.js.html" class="source "><span class="base_path">endPoints / auth / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/users/index.js.html" class="source "><span class="base_path">endPoints / users / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/collections/index.js.html" class="source "><span class="base_path">endPoints / collections / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/chat/index.js.html" class="source "><span class="base_path">endPoints / chat / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/songr/index.js.html" class="source "><span class="base_path">endPoints / songr / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/fs/index.js.html" class="source "><span class="base_path">endPoints / fs / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/songq/index.js.html" class="source "><span class="base_path">endPoints / songq / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/artists/index.js.html" class="source "><span class="base_path">endPoints / artists / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/albums/index.js.html" class="source "><span class="base_path">endPoints / albums / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/songp/index.js.html" class="source "><span class="base_path">endPoints / songp / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/index.js.html" class="source "><span class="base_path">endPoints / </span><span class="file_name">index.js</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>aurora.js</h1><div class="filepath">apps/jukebox/web/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Base</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">},</span>
  <span class="nx">__indexOf</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">indexOf</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">item</span><span class="p">)</span> <span class="k">return</span> <span class="nx">i</span><span class="p">;</span> <span class="p">}</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">Base</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">fnTest</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">Base</span><span class="p">()</span> <span class="p">{}</span>

  <span class="nx">fnTest</span> <span class="o">=</span> <span class="sr">/\b_super\b/</span><span class="p">;</span>

  <span class="nx">Base</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Class</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">,</span> <span class="nx">_super</span><span class="p">;</span>
    <span class="nx">Class</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">__extends</span><span class="p">(</span><span class="nx">Class</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">Class</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">Class</span><span class="p">;</span>

    <span class="p">})(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">prop</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">Class</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
      <span class="nx">prop</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">Class</span><span class="p">,</span> <span class="nx">Class</span><span class="p">);</span>
      <span class="nx">prop</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">_ref</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">_ref</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fn</span> <span class="o">=</span> <span class="nx">_ref</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">__indexOf</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">prop</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">_super</span> <span class="o">=</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">__super__</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fn</span> <span class="o">=</span> <span class="nx">prop</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">fn</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">fnTest</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">fn</span><span class="p">))</span> <span class="p">{</span>
        <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">Class</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ret</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">;</span>
            <span class="nx">tmp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_super</span> <span class="o">=</span> <span class="nx">_super</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
            <span class="nx">ret</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_super</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
          <span class="p">};</span>
        <span class="p">})(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Class</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">Class</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Base</span><span class="p">;</span>

<span class="p">})();</span>



<span class="kd">var</span> <span class="nx">Buffer</span><span class="p">;</span>

<span class="nx">Buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">BlobBuilder</span><span class="p">,</span> <span class="nx">URL</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">Buffer</span><span class="p">.</span><span class="nx">allocate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">size</span><span class="p">));</span>
  <span class="p">};</span>

  <span class="nx">Buffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">));</span>
  <span class="p">};</span>

  <span class="nx">Buffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">position</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">position</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">length</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">subarray</span><span class="p">(</span><span class="nx">position</span><span class="p">,</span> <span class="nx">position</span> <span class="o">+</span> <span class="nx">length</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">BlobBuilder</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">BlobBuilder</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">MozBlobBuilder</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">WebKitBlobBuilder</span><span class="p">;</span>

  <span class="nx">URL</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitURL</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">mozURL</span><span class="p">;</span>

  <span class="nx">Buffer</span><span class="p">.</span><span class="nx">makeBlob</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">bb</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">data</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">_error</span><span class="p">)</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">BlobBuilder</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BlobBuilder</span><span class="p">;</span>
      <span class="nx">bb</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">bb</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Buffer</span><span class="p">.</span><span class="nx">makeBlobURL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">URL</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">makeBlob</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="o">:</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Buffer</span><span class="p">.</span><span class="nx">revokeBlobURL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">URL</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">revokeObjectURL</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">:</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Buffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toBlob</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">makeBlob</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Buffer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toBlobURL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">makeBlobURL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Buffer</span><span class="p">;</span>

<span class="p">})();</span>



<span class="kd">var</span> <span class="nx">BufferList</span><span class="p">;</span>

<span class="nx">BufferList</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">BufferList</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">availableBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">availableBuffers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">first</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">BufferList</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BufferList</span><span class="p">;</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">buffers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">first</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">availableBytes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">availableBytes</span><span class="p">;</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">availableBuffers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">availableBuffers</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">BufferList</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shift</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">availableBytes</span> <span class="o">-=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">availableBuffers</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">first</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">BufferList</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">availableBytes</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">availableBuffers</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">first</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">first</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">BufferList</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">unshift</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">availableBytes</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">availableBuffers</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">first</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">BufferList</span><span class="p">;</span>

<span class="p">})();</span>



<span class="kd">var</span> <span class="nx">Stream</span><span class="p">;</span>

<span class="nx">Stream</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">buf</span><span class="p">,</span> <span class="nx">float32</span><span class="p">,</span> <span class="nx">float64</span><span class="p">,</span> <span class="nx">float64Fallback</span><span class="p">,</span> <span class="nx">float80</span><span class="p">,</span> <span class="nx">int16</span><span class="p">,</span> <span class="nx">int32</span><span class="p">,</span> <span class="nx">int8</span><span class="p">,</span> <span class="nx">nativeEndian</span><span class="p">,</span> <span class="nx">uint16</span><span class="p">,</span> <span class="nx">uint32</span><span class="p">,</span> <span class="nx">uint8</span><span class="p">;</span>

  <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

  <span class="nx">uint8</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>

  <span class="nx">int8</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int8Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>

  <span class="nx">uint16</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint16Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>

  <span class="nx">int16</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int16Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>

  <span class="nx">uint32</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>

  <span class="nx">int32</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>

  <span class="nx">float32</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">Float64Array</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">Float64Array</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">float64</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">nativeEndian</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint16Array</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">]).</span><span class="nx">buffer</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="mh">0x3412</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">Stream</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">list</span> <span class="o">=</span> <span class="nx">list</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">fromBuffer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">list</span><span class="p">;</span>
    <span class="nx">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BufferList</span><span class="p">;</span>
    <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Stream</span><span class="p">(</span><span class="nx">list</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stream</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">copy</span><span class="p">());</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">localOffset</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span><span class="p">;</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">available</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bytes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">bytes</span> <span class="o">&lt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">availableBytes</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remainingBytes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">availableBytes</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">advance</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bytes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span> <span class="o">+=</span> <span class="nx">bytes</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+=</span> <span class="nx">bytes</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">first</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">first</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span> <span class="o">-=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">shift</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readUInt8</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">;</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">first</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">first</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekUInt8</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">offset</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">;</span>
    <span class="nx">list</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">buffers</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">offset</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="nx">offset</span> <span class="o">-=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">read</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bytes</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_j</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">littleEndian</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">littleEndian</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">littleEndian</span> <span class="o">===</span> <span class="nx">nativeEndian</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">bytes</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">uint8</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_j</span> <span class="o">=</span> <span class="nx">_ref</span> <span class="o">=</span> <span class="nx">bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">_j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_j</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">uint8</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peek</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bytes</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_j</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">littleEndian</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">littleEndian</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">littleEndian</span> <span class="o">===</span> <span class="nx">nativeEndian</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">bytes</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">uint8</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="nx">offset</span> <span class="o">+</span> <span class="nx">i</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_j</span> <span class="o">&lt;</span> <span class="nx">bytes</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">uint8</span><span class="p">[</span><span class="nx">bytes</span> <span class="o">-</span> <span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="nx">offset</span> <span class="o">+</span> <span class="nx">i</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readInt8</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">int8</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekInt8</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">offset</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">int8</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readUInt16</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">uint16</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekUInt16</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">uint16</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readInt16</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">int16</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekInt16</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">int16</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readUInt24</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekUInt24</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">peekUInt16</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">peekUInt16</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readInt24</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readInt8</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readInt16</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekInt24</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">peekUInt16</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">peekInt8</span><span class="p">(</span><span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">peekInt16</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="nx">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readUInt32</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">uint32</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekUInt32</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">uint32</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readInt32</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">int32</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekInt32</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">int32</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readFloat32</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">float32</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekFloat32</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">float32</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readFloat64</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">float64</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">float64</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">float64Fallback</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">float64Fallback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">exp</span><span class="p">,</span> <span class="nx">frac</span><span class="p">,</span> <span class="nx">high</span><span class="p">,</span> <span class="nx">low</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">sign</span><span class="p">;</span>
    <span class="nx">low</span> <span class="o">=</span> <span class="nx">uint32</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">high</span> <span class="o">=</span> <span class="nx">uint32</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">high</span> <span class="o">||</span> <span class="nx">high</span> <span class="o">===</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="nx">high</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">exp</span> <span class="o">=</span> <span class="p">(</span><span class="nx">high</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
    <span class="nx">frac</span> <span class="o">=</span> <span class="nx">high</span> <span class="o">&amp;</span> <span class="mh">0xfffff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exp</span> <span class="o">===</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">frac</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">NaN</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">sign</span> <span class="o">*</span> <span class="kc">Infinity</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">exp</span> <span class="o">-=</span> <span class="mi">1023</span><span class="p">;</span>
    <span class="nx">out</span> <span class="o">=</span> <span class="p">(</span><span class="nx">frac</span> <span class="o">|</span> <span class="mh">0x100000</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">exp</span> <span class="o">-</span> <span class="mi">20</span><span class="p">);</span>
    <span class="nx">out</span> <span class="o">+=</span> <span class="nx">low</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">exp</span> <span class="o">-</span> <span class="mi">52</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">sign</span> <span class="o">*</span> <span class="nx">out</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekFloat64</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">float64</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">float64</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">float64Fallback</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readFloat80</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">float80</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">float80</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a0</span><span class="p">,</span> <span class="nx">a1</span><span class="p">,</span> <span class="nx">exp</span><span class="p">,</span> <span class="nx">high</span><span class="p">,</span> <span class="nx">low</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">sign</span><span class="p">;</span>
    <span class="nx">high</span> <span class="o">=</span> <span class="nx">uint32</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">low</span> <span class="o">=</span> <span class="nx">uint32</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">a0</span> <span class="o">=</span> <span class="nx">uint8</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
    <span class="nx">a1</span> <span class="o">=</span> <span class="nx">uint8</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="nx">sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="nx">a0</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">exp</span> <span class="o">=</span> <span class="p">((</span><span class="nx">a0</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="nx">a1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exp</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">low</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">high</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">exp</span> <span class="o">===</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">low</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">high</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">sign</span> <span class="o">*</span> <span class="kc">Infinity</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">NaN</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">exp</span> <span class="o">-=</span> <span class="mi">16383</span><span class="p">;</span>
    <span class="nx">out</span> <span class="o">=</span> <span class="nx">low</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">exp</span> <span class="o">-</span> <span class="mi">31</span><span class="p">);</span>
    <span class="nx">out</span> <span class="o">+=</span> <span class="nx">high</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">exp</span> <span class="o">-</span> <span class="mi">63</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">sign</span> <span class="o">*</span> <span class="nx">out</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekFloat80</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">peek</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">float80</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">_i</span><span class="p">;</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">()));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">_i</span><span class="p">;</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="nx">offset</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readUTF8</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="nx">length</span><span class="p">)));</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekUTF8</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">peekString</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">length</span><span class="p">)));</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readBuffer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">_i</span><span class="p">;</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">allocate</span><span class="p">(</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">to</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">to</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekBuffer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">_i</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">allocate</span><span class="p">(</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">to</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">to</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="nx">offset</span> <span class="o">+</span> <span class="nx">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readSingleBuffer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">first</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span><span class="p">,</span> <span class="nx">length</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekSingleBuffer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">first</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">localOffset</span><span class="p">,</span> <span class="nx">length</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Stream</span><span class="p">;</span>

<span class="p">})();</span>



<span class="kd">var</span> <span class="nx">Bitstream</span><span class="p">;</span>

<span class="nx">Bitstream</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">bitMask</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">Bitstream</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Bitstream</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">copy</span><span class="p">());</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">bitPosition</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">available</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bits</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">((</span><span class="nx">bits</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">advance</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bits</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span> <span class="o">+=</span> <span class="nx">bits</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">align</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readBig</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bits</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">val</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">bits</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">val</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">peekBig</span><span class="p">(</span><span class="nx">bits</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="nx">bits</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekBig</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bits</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">a0</span><span class="p">,</span> <span class="nx">a1</span><span class="p">,</span> <span class="nx">a2</span><span class="p">,</span> <span class="nx">a3</span><span class="p">,</span> <span class="nx">a4</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">bits</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">a0</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x0100000000</span><span class="p">;</span>
    <span class="nx">a1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x0001000000</span><span class="p">;</span>
    <span class="nx">a2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x0000010000</span><span class="p">;</span>
    <span class="nx">a3</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x0000000100</span><span class="p">;</span>
    <span class="nx">a4</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x0000000001</span><span class="p">;</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="nx">a0</span> <span class="o">+</span> <span class="nx">a1</span> <span class="o">+</span> <span class="nx">a2</span> <span class="o">+</span> <span class="nx">a3</span> <span class="o">+</span> <span class="nx">a4</span><span class="p">;</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">%</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">40</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">);</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">40</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span> <span class="o">-</span> <span class="nx">bits</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">read</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bits</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">bits</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="nx">bits</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="nx">bits</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readSigned</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bits</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">bits</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="nx">bits</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="nx">bits</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peek</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bits</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">bits</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="nx">bits</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readSmall</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bits</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">bits</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="p">((</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nx">bits</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="nx">bits</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekSmall</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bits</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">bits</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="p">((</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nx">bits</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readOne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">;</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="p">((</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">peekOne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">;</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="p">((</span><span class="nx">a</span> <span class="o">&lt;&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">bitMask</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">,</span> <span class="mh">0x00000007</span><span class="p">,</span> <span class="mh">0x0000000f</span><span class="p">,</span> <span class="mh">0x0000001f</span><span class="p">,</span> <span class="mh">0x0000003f</span><span class="p">,</span> <span class="mh">0x0000007f</span><span class="p">,</span> <span class="mh">0x000000ff</span><span class="p">,</span> <span class="mh">0x000001ff</span><span class="p">,</span> <span class="mh">0x000003ff</span><span class="p">,</span> <span class="mh">0x000007ff</span><span class="p">,</span> <span class="mh">0x00000fff</span><span class="p">,</span> <span class="mh">0x00001fff</span><span class="p">,</span> <span class="mh">0x00003fff</span><span class="p">,</span> <span class="mh">0x00007fff</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">,</span> <span class="mh">0x0001ffff</span><span class="p">,</span> <span class="mh">0x0003ffff</span><span class="p">,</span> <span class="mh">0x0007ffff</span><span class="p">,</span> <span class="mh">0x000fffff</span><span class="p">,</span> <span class="mh">0x001fffff</span><span class="p">,</span> <span class="mh">0x003fffff</span><span class="p">,</span> <span class="mh">0x007fffff</span><span class="p">,</span> <span class="mh">0x00ffffff</span><span class="p">,</span> <span class="mh">0x01ffffff</span><span class="p">,</span> <span class="mh">0x03ffffff</span><span class="p">,</span> <span class="mh">0x07ffffff</span><span class="p">,</span> <span class="mh">0x0fffffff</span><span class="p">,</span> <span class="mh">0x1fffffff</span><span class="p">,</span> <span class="mh">0x3fffffff</span><span class="p">,</span> <span class="mh">0x7fffffff</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">];</span>

  <span class="nx">Bitstream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readLSB</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bits</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">modBits</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">bits</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">modBits</span> <span class="o">=</span> <span class="nx">bits</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">;</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">modBits</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">a</span> <span class="o">|=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">modBits</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">a</span> <span class="o">|=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">modBits</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">a</span> <span class="o">|=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">24</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">modBits</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">a</span> <span class="o">|=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">peekUInt8</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitPosition</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="nx">bits</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">a</span> <span class="o">&amp;</span> <span class="nx">bitMask</span><span class="p">[</span><span class="nx">bits</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Bitstream</span><span class="p">;</span>

<span class="p">})();</span>



<span class="kd">var</span> <span class="nx">EventEmitter</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">},</span>
  <span class="nx">__slice</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">;</span>

<span class="nx">EventEmitter</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">EventEmitter</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">EventEmitter</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_base</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">,</span> <span class="nx">_ref1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">_ref1</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_base</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">)[</span><span class="nx">event</span><span class="p">])</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_base</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">off</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">_ref</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">:</span> <span class="k">void</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cb</span><span class="p">,</span>
      <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">cb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">,</span> <span class="nx">_ref1</span><span class="p">;</span>
    <span class="nx">event</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">args</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">__slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">_ref</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">:</span> <span class="k">void</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">_ref1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">event</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">_ref1</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fn</span> <span class="o">=</span> <span class="nx">_ref1</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
      <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">EventEmitter</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Base</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">Demuxer</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">Demuxer</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">formats</span><span class="p">;</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">Demuxer</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="nx">Demuxer</span><span class="p">.</span><span class="nx">probe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">Demuxer</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">received</span><span class="p">,</span>
      <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BufferList</span><span class="p">;</span>
    <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stream</span><span class="p">(</span><span class="nx">list</span><span class="p">);</span>
    <span class="nx">received</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">source</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">received</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">readChunk</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">source</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">source</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">received</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_this</span><span class="p">.</span><span class="nx">readChunk</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">Demuxer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

  <span class="nx">Demuxer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readChunk</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{};</span>

  <span class="nx">Demuxer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">seek</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">formats</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="nx">Demuxer</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">demuxer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">formats</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">demuxer</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Demuxer</span><span class="p">.</span><span class="nx">find</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">stream</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">;</span>
    <span class="nx">stream</span> <span class="o">=</span> <span class="nx">Stream</span><span class="p">.</span><span class="nx">fromBuffer</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">formats</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">format</span> <span class="o">=</span> <span class="nx">formats</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">format</span><span class="p">.</span><span class="nx">probe</span><span class="p">(</span><span class="nx">stream</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">format</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Demuxer</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">EventEmitter</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">Decoder</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">Decoder</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">codecs</span><span class="p">;</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">Decoder</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">Decoder</span><span class="p">(</span><span class="nx">demuxer</span><span class="p">,</span> <span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">list</span><span class="p">,</span>
      <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="nx">format</span><span class="p">;</span>
    <span class="nx">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BufferList</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stream</span><span class="p">(</span><span class="nx">list</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bitstream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Bitstream</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">receivedFinalBuffer</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">demuxer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cookie</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">setCookie</span><span class="p">(</span><span class="nx">cookie</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">demuxer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="kr">final</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">receivedFinalBuffer</span> <span class="o">=</span> <span class="o">!!</span><span class="kr">final</span><span class="p">;</span>
      <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;available&#39;</span><span class="p">);</span>
      <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">Decoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

  <span class="nx">Decoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setCookie</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cookie</span><span class="p">)</span> <span class="p">{};</span>

  <span class="nx">Decoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readChunk</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

  <span class="nx">Decoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">seek</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">position</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">&#39;Not Implemented.&#39;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">codecs</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="nx">Decoder</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">decoder</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">codecs</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">decoder</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Decoder</span><span class="p">.</span><span class="nx">find</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">codecs</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Decoder</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">EventEmitter</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">Queue</span><span class="p">,</span>
  <span class="nx">__bind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">me</span><span class="p">){</span> <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span> <span class="p">},</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">Queue</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">Queue</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">Queue</span><span class="p">(</span><span class="nx">decoder</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span> <span class="o">=</span> <span class="nx">decoder</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">write</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">write</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">readyMark</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">finished</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buffering</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">write</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">readChunk</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">Queue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">write</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buffering</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyMark</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">receivedFinalBuffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">buffering</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">readChunk</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Queue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">read</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">readChunk</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Queue</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">EventEmitter</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">AudioDevice</span><span class="p">,</span>
  <span class="nx">__bind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">me</span><span class="p">){</span> <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span> <span class="p">},</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">AudioDevice</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">devices</span><span class="p">;</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">AudioDevice</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">AudioDevice</span><span class="p">(</span><span class="nx">sampleRate</span><span class="p">,</span> <span class="nx">channels</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">=</span> <span class="nx">sampleRate</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">channels</span> <span class="o">=</span> <span class="nx">channels</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">updateTime</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">updateTime</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">playing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_lastTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">AudioDevice</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_ref</span><span class="p">,</span>
      <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">playing</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">playing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">device</span> <span class="o">=</span> <span class="nx">AudioDevice</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_lastTime</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">getDeviceTime</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_timer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">updateTime</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;refill&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">refill</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;refill&#39;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">AudioDevice</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">playing</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">playing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s1">&#39;refill&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">refill</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">clearInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_timer</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">AudioDevice</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">AudioDevice</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">seek</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">currentTime</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">=</span> <span class="nx">currentTime</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_lastTime</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">getDeviceTime</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;timeUpdate&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">AudioDevice</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateTime</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">time</span><span class="p">;</span>
    <span class="nx">time</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">getDeviceTime</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">time</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">_lastTime</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_lastTime</span> <span class="o">=</span> <span class="nx">time</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;timeUpdate&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">devices</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="nx">AudioDevice</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">device</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">devices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">device</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">AudioDevice</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sampleRate</span><span class="p">,</span> <span class="nx">channels</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">device</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">devices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">device</span> <span class="o">=</span> <span class="nx">devices</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">device</span><span class="p">.</span><span class="nx">supported</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">device</span><span class="p">(</span><span class="nx">sampleRate</span><span class="p">,</span> <span class="nx">channels</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">AudioDevice</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">EventEmitter</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">Asset</span><span class="p">,</span>
  <span class="nx">__bind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">me</span><span class="p">){</span> <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span> <span class="p">},</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">Asset</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">Asset</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="nb">window</span><span class="p">.</span><span class="nx">Asset</span> <span class="o">=</span> <span class="nx">Asset</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">Asset</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">findDecoder</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">findDecoder</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">probe</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">probe</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">buffered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">metadata</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">demuxer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">probe</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffered</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">buffered</span> <span class="o">=</span> <span class="nx">buffered</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;buffer&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">buffered</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">Asset</span><span class="p">.</span><span class="nx">fromURL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">source</span><span class="p">;</span>
    <span class="nx">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HTTPSource</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Asset</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Asset</span><span class="p">.</span><span class="nx">fromFile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">source</span><span class="p">;</span>
    <span class="nx">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileSource</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Asset</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Asset</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">Asset</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">Asset</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">!==</span> <span class="s1">&#39;format&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span> <span class="o">!==</span> <span class="s1">&#39;duration&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span> <span class="o">!==</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">event</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Asset</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">probe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">demuxer</span><span class="p">,</span>
      <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">demuxer</span> <span class="o">=</span> <span class="nx">Demuxer</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">demuxer</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;A demuxer for this container was not found.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">demuxer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">demuxer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">demuxer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">findDecoder</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">demuxer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="nx">duration</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">duration</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">demuxer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">metadata</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">metadata</span> <span class="o">=</span> <span class="nx">metadata</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">metadata</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">demuxer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">Asset</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">findDecoder</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">decoder</span><span class="p">,</span>
      <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="nx">format</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">);</span>
    <span class="nx">decoder</span> <span class="o">=</span> <span class="nx">Decoder</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">formatID</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">decoder</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s2">&quot;A decoder for &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">formatID</span> <span class="o">+</span> <span class="s2">&quot; was not found.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">decoder</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">demuxer</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;decodeStart&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Asset</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">EventEmitter</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">Player</span><span class="p">,</span>
  <span class="nx">__bind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">me</span><span class="p">){</span> <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span> <span class="p">},</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">Player</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">Player</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="nb">window</span><span class="p">.</span><span class="nx">Player</span> <span class="o">=</span> <span class="nx">Player</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">Player</span><span class="p">(</span><span class="nx">asset</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">asset</span> <span class="o">=</span> <span class="nx">asset</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">startPlaying</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">startPlaying</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">playing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buffered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">volume</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">metadata</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">filters</span> <span class="o">=</span> <span class="p">[</span><span class="k">new</span> <span class="nx">VolumeFilter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">),</span> <span class="k">new</span> <span class="nx">BalanceFilter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;pan&#39;</span><span class="p">)];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">asset</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;buffer&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffered</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">buffered</span> <span class="o">=</span> <span class="nx">buffered</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;buffer&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">buffered</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">asset</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;decodeStart&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Queue</span><span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">asset</span><span class="p">.</span><span class="nx">decoder</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">startPlaying</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">asset</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="nx">format</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">format</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">asset</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">metadata</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">metadata</span> <span class="o">=</span> <span class="nx">metadata</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">metadata</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">asset</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="nx">duration</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">duration</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">asset</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">Player</span><span class="p">.</span><span class="nx">fromURL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">asset</span><span class="p">;</span>
    <span class="nx">asset</span> <span class="o">=</span> <span class="nx">Asset</span><span class="p">.</span><span class="nx">fromURL</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Player</span><span class="p">(</span><span class="nx">asset</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Player</span><span class="p">.</span><span class="nx">fromFile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">asset</span><span class="p">;</span>
    <span class="nx">asset</span> <span class="o">=</span> <span class="nx">Asset</span><span class="p">.</span><span class="nx">fromFile</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Player</span><span class="p">(</span><span class="nx">asset</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">preload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">asset</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">startedPreloading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">asset</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">play</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">playing</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">startedPreloading</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">preload</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">playing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">_ref</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span> <span class="o">:</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pause</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">playing</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">playing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">_ref</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span> <span class="o">:</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">togglePlayback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">playing</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">play</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">asset</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">_ref</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span> <span class="o">:</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">startPlaying</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">decoder</span><span class="p">,</span> <span class="nx">div</span><span class="p">,</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">frame</span><span class="p">,</span> <span class="nx">frameOffset</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">,</span>
      <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">frame</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">read</span><span class="p">();</span>
    <span class="nx">frameOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">asset</span><span class="p">,</span> <span class="nx">format</span> <span class="o">=</span> <span class="nx">_ref</span><span class="p">.</span><span class="nx">format</span><span class="p">,</span> <span class="nx">decoder</span> <span class="o">=</span> <span class="nx">_ref</span><span class="p">.</span><span class="nx">decoder</span><span class="p">;</span>
    <span class="nx">div</span> <span class="o">=</span> <span class="nx">decoder</span><span class="p">.</span><span class="nx">floatingPoint</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nx">bitsPerChannel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">device</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AudioDevice</span><span class="p">(</span><span class="nx">format</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nx">channelsPerFrame</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;timeUpdate&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">currentTime</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">=</span> <span class="nx">currentTime</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">refill</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">bufferOffset</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">max</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_j</span><span class="p">,</span> <span class="nx">_len</span><span class="p">,</span> <span class="nx">_ref1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_this</span><span class="p">.</span><span class="nx">playing</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">bufferOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">frame</span> <span class="o">&amp;&amp;</span> <span class="nx">bufferOffset</span> <span class="o">&lt;</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">max</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">frame</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">frameOffset</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">bufferOffset</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">max</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">buffer</span><span class="p">[</span><span class="nx">bufferOffset</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">[</span><span class="nx">frameOffset</span><span class="o">++</span><span class="p">]</span> <span class="o">/</span> <span class="nx">div</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">frameOffset</span> <span class="o">===</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">frame</span> <span class="o">=</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">read</span><span class="p">();</span>
          <span class="nx">frameOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">_ref1</span> <span class="o">=</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">filters</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">_j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">_ref1</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_j</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">filter</span> <span class="o">=</span> <span class="nx">_ref1</span><span class="p">[</span><span class="nx">_j</span><span class="p">];</span>
        <span class="nx">filter</span><span class="p">.</span><span class="nx">process</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">receivedFinalBuffer</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">_this</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">=</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">duration</span><span class="p">;</span>
          <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">);</span>
          <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">);</span>
          <span class="nx">_this</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">_this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;refill&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">refill</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">playing</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Player</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">EventEmitter</span><span class="p">);</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>This resampler is from XAudioJS: <a href='https://github.com/grantgalitz/XAudioJS'>https://github.com/grantgalitz/XAudioJS</a><br />Planned to be replaced with src.js, eventually: <a href='https://github.com/jussi-kalliokoski/src.js'>https://github.com/jussi-kalliokoski/src.js</a></p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>JavaScript Audio Resampler (c) 2011 - Grant Galitz</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">Resampler</span><span class="p">(</span><span class="nx">fromSampleRate</span><span class="p">,</span> <span class="nx">toSampleRate</span><span class="p">,</span> <span class="nx">channels</span><span class="p">,</span> <span class="nx">outputBufferSize</span><span class="p">,</span> <span class="nx">noReturn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">fromSampleRate</span> <span class="o">=</span> <span class="nx">fromSampleRate</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">toSampleRate</span> <span class="o">=</span> <span class="nx">toSampleRate</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">channels</span> <span class="o">=</span> <span class="nx">channels</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">outputBufferSize</span> <span class="o">=</span> <span class="nx">outputBufferSize</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">noReturn</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">noReturn</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">Resampler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Perform some checks:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fromSampleRate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">toSampleRate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fromSampleRate</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">toSampleRate</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Setup a resampler bypass:</p>
</td><td class="code"><div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">resampler</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bypassResampler</span><span class="p">;</span>    <span class="c1">//Resampler just returns what was passed through.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">ratioWeight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fromSampleRate</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">toSampleRate</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Use generic linear interpolation if upsampling,<br />                    as linear interpolation produces a gradient that we want<br />                    and works fine with two input sample points per output in this case.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">compileLinearInterpolationFunction</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">lastWeight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Custom resampler I wrote that doesn't skip samples<br />                    like standard linear interpolation in high downsampling.<br />                    This is more accurate than linear interpolation on downsampling.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">compileMultiTapFunction</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">tailExists</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">lastWeight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">ratioWeight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fromSampleRate</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">toSampleRate</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">initializeBuffers</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">throw</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid settings specified for the resampler.&quot;</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">Resampler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">compileLinearInterpolationFunction</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">toCompile</span> <span class="o">=</span> <span class="s2">&quot;var bufferLength = buffer.length;\</span>
<span class="s2">  var outLength = this.outputBufferSize;\</span>
<span class="s2">  if ((bufferLength % &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span> <span class="o">+</span> <span class="s2">&quot;) == 0) {\</span>
<span class="s2">    if (bufferLength &gt; 0) {\</span>
<span class="s2">      var ratioWeight = this.ratioWeight;\</span>
<span class="s2">      var weight = this.lastWeight;\</span>
<span class="s2">      var firstWeight = 0;\</span>
<span class="s2">      var secondWeight = 0;\</span>
<span class="s2">      var sourceOffset = 0;\</span>
<span class="s2">      var outputOffset = 0;\</span>
<span class="s2">      var outputBuffer = this.outputBuffer;\</span>
<span class="s2">      for (; weight &lt; 1; weight += ratioWeight) {\</span>
<span class="s2">        secondWeight = weight % 1;\</span>
<span class="s2">        firstWeight = 1 - secondWeight;&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">channel</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">;</span> <span class="o">++</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;outputBuffer[outputOffset++] = (this.lastOutput[&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="o">+</span> <span class="s2">&quot;] * firstWeight) + (buffer[&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="o">+</span> <span class="s2">&quot;] * secondWeight);&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;}\</span>
<span class="s2">      weight -= 1;\</span>
<span class="s2">      for (bufferLength -= &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span> <span class="o">+</span> <span class="s2">&quot;, sourceOffset = Math.floor(weight) * &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span> <span class="o">+</span> <span class="s2">&quot;; outputOffset &lt; outLength &amp;&amp; sourceOffset &lt; bufferLength;) {\</span>
<span class="s2">        secondWeight = weight % 1;\</span>
<span class="s2">        firstWeight = 1 - secondWeight;&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">channel</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">;</span> <span class="o">++</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;outputBuffer[outputOffset++] = (buffer[sourceOffset&quot;</span> <span class="o">+</span> <span class="p">((</span><span class="nx">channel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="s2">&quot; + &quot;</span> <span class="o">+</span> <span class="nx">channel</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;] * firstWeight) + (buffer[sourceOffset + &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">channels</span> <span class="o">+</span> <span class="nx">channel</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;] * secondWeight);&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;weight += ratioWeight;\</span>
<span class="s2">        sourceOffset = Math.floor(weight) * &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span> <span class="o">+</span> <span class="s2">&quot;;\</span>
<span class="s2">      }&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">channel</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">;</span> <span class="o">++</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;this.lastOutput[&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="o">+</span> <span class="s2">&quot;] = buffer[sourceOffset++];&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;this.lastWeight = weight % 1;\</span>
<span class="s2">      return this.bufferSlice(outputOffset);\</span>
<span class="s2">    }\</span>
<span class="s2">    else {\</span>
<span class="s2">      return (this.noReturn) ? 0 : [];\</span>
<span class="s2">    }\</span>
<span class="s2">  }\</span>
<span class="s2">  else {\</span>
<span class="s2">    throw(new Error(\&quot;Buffer was of incorrect sample length.\&quot;));\</span>
<span class="s2">  }&quot;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">resampler</span> <span class="o">=</span> <span class="nb">Function</span><span class="p">(</span><span class="s2">&quot;buffer&quot;</span><span class="p">,</span> <span class="nx">toCompile</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Resampler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">compileMultiTapFunction</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">toCompile</span> <span class="o">=</span> <span class="s2">&quot;var bufferLength = buffer.length;\</span>
<span class="s2">  var outLength = this.outputBufferSize;\</span>
<span class="s2">  if ((bufferLength % &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span> <span class="o">+</span> <span class="s2">&quot;) == 0) {\</span>
<span class="s2">    if (bufferLength &gt; 0) {\</span>
<span class="s2">      var ratioWeight = this.ratioWeight;\</span>
<span class="s2">      var weight = 0;&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">channel</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">;</span> <span class="o">++</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;var output&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="o">+</span> <span class="s2">&quot; = 0;&quot;</span>
  <span class="p">}</span>
  <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;var actualPosition = 0;\</span>
<span class="s2">      var amountToNext = 0;\</span>
<span class="s2">      var alreadyProcessedTail = !this.tailExists;\</span>
<span class="s2">      this.tailExists = false;\</span>
<span class="s2">      var outputBuffer = this.outputBuffer;\</span>
<span class="s2">      var outputOffset = 0;\</span>
<span class="s2">      var currentPosition = 0;\</span>
<span class="s2">      do {\</span>
<span class="s2">        if (alreadyProcessedTail) {\</span>
<span class="s2">          weight = ratioWeight;&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">channel</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">;</span> <span class="o">++</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;output&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="o">+</span> <span class="s2">&quot; = 0;&quot;</span>
  <span class="p">}</span>
  <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;}\</span>
<span class="s2">        else {\</span>
<span class="s2">          weight = this.lastWeight;&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">channel</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">;</span> <span class="o">++</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;output&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="o">+</span> <span class="s2">&quot; = this.lastOutput[&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="o">+</span> <span class="s2">&quot;];&quot;</span>
  <span class="p">}</span>
  <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;alreadyProcessedTail = true;\</span>
<span class="s2">        }\</span>
<span class="s2">        while (weight &gt; 0 &amp;&amp; actualPosition &lt; bufferLength) {\</span>
<span class="s2">          amountToNext = 1 + actualPosition - currentPosition;\</span>
<span class="s2">          if (weight &gt;= amountToNext) {&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">channel</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">;</span> <span class="o">++</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;output&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="o">+</span> <span class="s2">&quot; += buffer[actualPosition++] * amountToNext;&quot;</span>
  <span class="p">}</span>
  <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;currentPosition = actualPosition;\</span>
<span class="s2">            weight -= amountToNext;\</span>
<span class="s2">          }\</span>
<span class="s2">          else {&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">channel</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">;</span> <span class="o">++</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;output&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="o">+</span> <span class="s2">&quot; += buffer[actualPosition&quot;</span> <span class="o">+</span> <span class="p">((</span><span class="nx">channel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="s2">&quot; + &quot;</span> <span class="o">+</span> <span class="nx">channel</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;] * weight;&quot;</span>
  <span class="p">}</span>
  <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;currentPosition += weight;\</span>
<span class="s2">            weight = 0;\</span>
<span class="s2">            break;\</span>
<span class="s2">          }\</span>
<span class="s2">        }\</span>
<span class="s2">        if (weight == 0) {&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">channel</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">;</span> <span class="o">++</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;outputBuffer[outputOffset++] = output&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="o">+</span> <span class="s2">&quot; / ratioWeight;&quot;</span>
  <span class="p">}</span>
  <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;}\</span>
<span class="s2">        else {\</span>
<span class="s2">          this.lastWeight = weight;&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">channel</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">;</span> <span class="o">++</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;this.lastOutput[&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="o">+</span> <span class="s2">&quot;] = output&quot;</span> <span class="o">+</span> <span class="nx">channel</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
  <span class="p">}</span>
  <span class="nx">toCompile</span> <span class="o">+=</span> <span class="s2">&quot;this.tailExists = true;\</span>
<span class="s2">          break;\</span>
<span class="s2">        }\</span>
<span class="s2">      } while (actualPosition &lt; bufferLength &amp;&amp; outputOffset &lt; outLength);\</span>
<span class="s2">      return this.bufferSlice(outputOffset);\</span>
<span class="s2">    }\</span>
<span class="s2">    else {\</span>
<span class="s2">      return (this.noReturn) ? 0 : [];\</span>
<span class="s2">    }\</span>
<span class="s2">  }\</span>
<span class="s2">  else {\</span>
<span class="s2">    throw(new Error(\&quot;Buffer was of incorrect sample length.\&quot;));\</span>
<span class="s2">  }&quot;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">resampler</span> <span class="o">=</span> <span class="nb">Function</span><span class="p">(</span><span class="s2">&quot;buffer&quot;</span><span class="p">,</span> <span class="nx">toCompile</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Resampler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bypassResampler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">noReturn</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Set the buffer passed as our own, as we don't need to resample it:</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">outputBuffer</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Just return the buffer passsed:</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="nx">buffer</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">Resampler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bufferSlice</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">sliceAmount</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">noReturn</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>If we're going to access the properties directly from this object:</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="nx">sliceAmount</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Typed array and normal array buffer section referencing:</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">subarray</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sliceAmount</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Regular array pass:</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">sliceAmount</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Nightly Firefox 4 used to have the subarray function named as slice:</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sliceAmount</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">Resampler</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initializeBuffers</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Initialize the internal buffer:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">try</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">outputBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">outputBufferSize</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lastOutput</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">outputBuffer</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lastOutput</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">WebKitAudioDevice</span><span class="p">,</span>
  <span class="nx">__bind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">me</span><span class="p">){</span> <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span> <span class="p">},</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">WebKitAudioDevice</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">AudioContext</span><span class="p">,</span> <span class="nx">sharedContext</span><span class="p">;</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">WebKitAudioDevice</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="nx">AudioDevice</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">WebKitAudioDevice</span><span class="p">);</span>

  <span class="nx">AudioContext</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">AudioContext</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitAudioContext</span><span class="p">;</span>

  <span class="nx">WebKitAudioDevice</span><span class="p">.</span><span class="nx">supported</span> <span class="o">=</span> <span class="nx">AudioContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="nx">sharedContext</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">WebKitAudioDevice</span><span class="p">(</span><span class="nx">sampleRate</span><span class="p">,</span> <span class="nx">channels</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">=</span> <span class="nx">sampleRate</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">channels</span> <span class="o">=</span> <span class="nx">channels</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">refill</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">refill</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nx">sharedContext</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">sharedContext</span> <span class="o">:</span> <span class="nx">sharedContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AudioContext</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">deviceChannels</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">destination</span><span class="p">.</span><span class="nx">numberOfChannels</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">deviceSampleRate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="mi">4096</span> <span class="o">/</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">deviceSampleRate</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">)</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bufferSize</span> <span class="o">%</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">deviceSampleRate</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">resampler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Resampler</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">deviceSampleRate</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">,</span> <span class="mi">4096</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">createJavaScriptNode</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">onaudioprocess</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">refill</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">WebKitAudioDevice</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">refill</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">channelCount</span><span class="p">,</span> <span class="nx">channels</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">outputBuffer</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_j</span><span class="p">,</span> <span class="nx">_k</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="nx">outputBuffer</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">outputBuffer</span><span class="p">;</span>
    <span class="nx">channelCount</span> <span class="o">=</span> <span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">numberOfChannels</span><span class="p">;</span>
    <span class="nx">channels</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">channelCount</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">channelCount</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">channels</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">getChannelData</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bufferSize</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;refill&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">resampler</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">resampler</span><span class="p">.</span><span class="nx">resampler</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_ref</span> <span class="o">=</span> <span class="nx">outputBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_j</span> <span class="o">&lt;</span> <span class="nx">_ref</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">_k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_k</span> <span class="o">&lt;</span> <span class="nx">channelCount</span><span class="p">;</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">_k</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">channels</span><span class="p">[</span><span class="nx">n</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">*</span> <span class="nx">channelCount</span> <span class="o">+</span> <span class="nx">n</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">WebKitAudioDevice</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">WebKitAudioDevice</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getDeviceTime</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">currentTime</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">deviceSampleRate</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">WebKitAudioDevice</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">EventEmitter</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">MozillaAudioDevice</span><span class="p">,</span>
  <span class="nx">__bind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">me</span><span class="p">){</span> <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span> <span class="p">},</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">MozillaAudioDevice</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">createTimer</span><span class="p">,</span> <span class="nx">destroyTimer</span><span class="p">;</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">MozillaAudioDevice</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="nx">AudioDevice</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">MozillaAudioDevice</span><span class="p">);</span>

  <span class="nx">MozillaAudioDevice</span><span class="p">.</span><span class="nx">supported</span> <span class="o">=</span> <span class="s1">&#39;mozWriteAudio&#39;</span> <span class="k">in</span> <span class="k">new</span> <span class="nx">Audio</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">MozillaAudioDevice</span><span class="p">(</span><span class="nx">sampleRate</span><span class="p">,</span> <span class="nx">channels</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">=</span> <span class="nx">sampleRate</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">channels</span> <span class="o">=</span> <span class="nx">channels</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">refill</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">refill</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">audio</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Audio</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">audio</span><span class="p">.</span><span class="nx">mozSetup</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">sampleRate</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">writePosition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">prebufferSize</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">tail</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timer</span> <span class="o">=</span> <span class="nx">createTimer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">refill</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">MozillaAudioDevice</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">refill</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">available</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">currentPosition</span><span class="p">,</span> <span class="nx">written</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tail</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">written</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">audio</span><span class="p">.</span><span class="nx">mozWriteAudio</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tail</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">writePosition</span> <span class="o">+=</span> <span class="nx">written</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tailPosition</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">tail</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">tail</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tail</span><span class="p">.</span><span class="nx">subarray</span><span class="p">(</span><span class="nx">written</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">tail</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">currentPosition</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">audio</span><span class="p">.</span><span class="nx">mozCurrentSampleOffset</span><span class="p">();</span>
    <span class="nx">available</span> <span class="o">=</span> <span class="nx">currentPosition</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">prebufferSize</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">writePosition</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">available</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">available</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;refill&#39;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span>
      <span class="nx">written</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">audio</span><span class="p">.</span><span class="nx">mozWriteAudio</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">written</span> <span class="o">&lt;</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">tail</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">subarray</span><span class="p">(</span><span class="nx">written</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">writePosition</span> <span class="o">+=</span> <span class="nx">written</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">MozillaAudioDevice</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">destroyTimer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timer</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">MozillaAudioDevice</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getDeviceTime</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">audio</span><span class="p">.</span><span class="nx">mozCurrentSampleOffset</span><span class="p">()</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">channels</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">createTimer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">interval</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">worker</span><span class="p">;</span>
    <span class="nx">url</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">makeBlobURL</span><span class="p">(</span><span class="s2">&quot;setInterval(function() { postMessage(&#39;ping&#39;); }, &quot;</span> <span class="o">+</span> <span class="nx">interval</span> <span class="o">+</span> <span class="s2">&quot;);&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">url</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">setInterval</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">interval</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Worker</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
    <span class="nx">worker</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">worker</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">destroyTimer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">timer</span><span class="p">.</span><span class="nx">terminate</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">timer</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">revokeObjectURL</span><span class="p">(</span><span class="nx">timer</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">MozillaAudioDevice</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">EventEmitter</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">HTTPSource</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">HTTPSource</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">HTTPSource</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">HTTPSource</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">chunkSize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">inflight</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">HTTPSource</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">inflight</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">));</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">inflight</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">loop</span><span class="p">();</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onabort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;HTTP Aborted: Paused?&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">inflight</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;HEAD&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">HTTPSource</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">endPos</span><span class="p">,</span>
      <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inflight</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Something is wrong in HTTPSource.loop&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">inflight</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">inflight</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onprogress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">loaded</span><span class="p">)</span> <span class="o">/</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">buf</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">txt</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">txt</span> <span class="o">=</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
        <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">txt</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_ref</span> <span class="o">=</span> <span class="nx">txt</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">_ref</span> <span class="o">?</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_ref</span> <span class="o">:</span> <span class="nx">_i</span> <span class="o">&gt;</span> <span class="nx">_ref</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">_ref</span> <span class="o">?</span> <span class="o">++</span><span class="nx">_i</span> <span class="o">:</span> <span class="o">--</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">txt</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">===</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">/</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">inflight</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">loop</span><span class="p">();</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onabort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">inflight</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="s2">&quot;arraybuffer&quot;</span><span class="p">;</span>
    <span class="nx">endPos</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Range&quot;</span><span class="p">,</span> <span class="s2">&quot;bytes=&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">endPos</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">overrideMimeType</span><span class="p">(</span><span class="s1">&#39;text/plain; charset=x-user-defined&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">HTTPSource</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pause</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">inflight</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">_ref</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span> <span class="o">:</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">HTTPSource</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">HTTPSource</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">EventEmitter</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">FileSource</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">FileSource</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">FileSource</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">FileSource</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">file</span> <span class="o">=</span> <span class="nx">file</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">FileReader</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;This browser does not have FileReader support.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">chunkSize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">FileSource</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">buf</span><span class="p">;</span>
      <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">));</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">buf</span><span class="p">);</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">/</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">&lt;</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">loop</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reader</span><span class="p">.</span><span class="nx">onloadend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">===</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">reader</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reader</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reader</span><span class="p">.</span><span class="nx">onprogress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">loaded</span><span class="p">)</span> <span class="o">/</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">loop</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">FileSource</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">blob</span><span class="p">,</span> <span class="nx">endPos</span><span class="p">,</span> <span class="nx">slice</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">file</span><span class="p">[</span><span class="nx">slice</span> <span class="o">=</span> <span class="s1">&#39;slice&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">file</span><span class="p">[</span><span class="nx">slice</span> <span class="o">=</span> <span class="s1">&#39;webkitSlice&#39;</span><span class="p">]</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">file</span><span class="p">[</span><span class="nx">slice</span> <span class="o">=</span> <span class="s1">&#39;mozSlice&#39;</span><span class="p">];</span>
    <span class="nx">endPos</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">chunkSize</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">blob</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">file</span><span class="p">[</span><span class="nx">slice</span><span class="p">](</span><span class="k">this</span><span class="p">.</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">endPos</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">reader</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">FileSource</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pause</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">reader</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">_ref</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span> <span class="o">:</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">FileSource</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">FileSource</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">EventEmitter</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">Filter</span><span class="p">;</span>

<span class="nx">Filter</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">Filter</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span> <span class="o">&amp;&amp;</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">context</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">Filter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">process</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{};</span>

  <span class="k">return</span> <span class="nx">Filter</span><span class="p">;</span>

<span class="p">})();</span>



<span class="kd">var</span> <span class="nx">VolumeFilter</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">VolumeFilter</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">VolumeFilter</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">VolumeFilter</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">VolumeFilter</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">VolumeFilter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">process</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">vol</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">vol</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_ref</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_ref</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">*=</span> <span class="nx">vol</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">VolumeFilter</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Filter</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">BalanceFilter</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">BalanceFilter</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">BalanceFilter</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">BalanceFilter</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">BalanceFilter</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">BalanceFilter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">process</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">pan</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">pan</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_ref</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_ref</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">*=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">50</span> <span class="o">-</span> <span class="nx">pan</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span><span class="p">);</span>
      <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">50</span> <span class="o">+</span> <span class="nx">pan</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">BalanceFilter</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Filter</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">EarwaxFilter</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">EarwaxFilter</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">NUMTAPS</span><span class="p">,</span> <span class="nx">filt</span><span class="p">;</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">EarwaxFilter</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="nx">filt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int8Array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>

  <span class="nx">NUMTAPS</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">EarwaxFilter</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">taps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">NUMTAPS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">EarwaxFilter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">process</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="nx">len</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">output</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="nx">_ref</span> <span class="o">=</span> <span class="nx">NUMTAPS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">taps</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">taps</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
        <span class="nx">output</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">taps</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">*</span> <span class="nx">filt</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">taps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>
      <span class="nx">output</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">taps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">filt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">buffer</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">output</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">EarwaxFilter</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Filter</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">CAFDemuxer</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">CAFDemuxer</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">CAFDemuxer</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">CAFDemuxer</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">CAFDemuxer</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">Demuxer</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">CAFDemuxer</span><span class="p">);</span>

  <span class="nx">CAFDemuxer</span><span class="p">.</span><span class="nx">probe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">peekString</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;caff&#39;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">CAFDemuxer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readChunk</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buffer</span><span class="p">,</span> <span class="kr">char</span><span class="p">,</span> <span class="nx">entries</span><span class="p">,</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">metadata</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">_i</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;caff&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s2">&quot;Invalid CAF, does not begin with &#39;caff&#39;&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;desc&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s2">&quot;Invalid CAF, &#39;caff&#39; is not followed by &#39;desc&#39;&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">()</span> <span class="o">===</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s2">&quot;Invalid &#39;desc&#39; size, should be 32&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readFloat64</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">formatID</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
      <span class="nx">flags</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">floatingPoint</span> <span class="o">=</span> <span class="nb">Boolean</span><span class="p">(</span><span class="nx">flags</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">littleEndian</span> <span class="o">=</span> <span class="nb">Boolean</span><span class="p">(</span><span class="nx">flags</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bytesPerPacket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">framesPerPacket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">channelsPerFrame</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bitsPerChannel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
          <span class="nx">oversize</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">()</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nx">size</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">()</span>
        <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">oversize</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s2">&quot;Holy Shit, an oversized file, not supported in JS&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;kuki&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">formatID</span> <span class="o">===</span> <span class="s1">&#39;aac &#39;</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
              <span class="nx">M4ADemuxer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readEsds</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">buffer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readBuffer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;pakt&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">()</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Sizes greater than 32 bits are not supported.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">numPackets</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">()</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Sizes greater than 32 bits are not supported.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">numFrames</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">primingFrames</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">remainderFrames</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">numFrames</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">sentDuration</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">24</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;info&#39;</span><span class="o">:</span>
          <span class="nx">entries</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
          <span class="nx">metadata</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">entries</span> <span class="o">?</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">entries</span> <span class="o">:</span> <span class="nx">_i</span> <span class="o">&gt;</span> <span class="nx">entries</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">entries</span> <span class="o">?</span> <span class="o">++</span><span class="nx">_i</span> <span class="o">:</span> <span class="o">--</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">((</span><span class="kr">char</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">())</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">key</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="kr">char</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">((</span><span class="kr">char</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">())</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">value</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="kr">char</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">metadata</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="nx">metadata</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;data&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">sentFirstDataChunk</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bytesPerPacket</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">sentDuration</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">numFrames</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bytesPerPacket</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">numFrames</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">sentFirstDataChunk</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">buffer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readSingleBuffer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span> <span class="o">-=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">headerCache</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">CAFDemuxer</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Demuxer</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">M4ADemuxer</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">M4ADemuxer</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">genres</span><span class="p">,</span> <span class="nx">metafields</span><span class="p">,</span> <span class="nx">readDescr</span><span class="p">;</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">M4ADemuxer</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">M4ADemuxer</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">M4ADemuxer</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">Demuxer</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">M4ADemuxer</span><span class="p">);</span>

  <span class="nx">M4ADemuxer</span><span class="p">.</span><span class="nx">probe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">peekString</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;M4A &#39;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">metafields</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;alb&#39;</span><span class="o">:</span> <span class="s1">&#39;Album&#39;</span><span class="p">,</span>
    <span class="s1">&#39;arg&#39;</span><span class="o">:</span> <span class="s1">&#39;Arranger&#39;</span><span class="p">,</span>
    <span class="s1">&#39;art&#39;</span><span class="o">:</span> <span class="s1">&#39;Artist&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ART&#39;</span><span class="o">:</span> <span class="s1">&#39;Album Artist&#39;</span><span class="p">,</span>
    <span class="s1">&#39;catg&#39;</span><span class="o">:</span> <span class="s1">&#39;Category&#39;</span><span class="p">,</span>
    <span class="s1">&#39;com&#39;</span><span class="o">:</span> <span class="s1">&#39;Composer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;covr&#39;</span><span class="o">:</span> <span class="s1">&#39;Cover Art&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cpil&#39;</span><span class="o">:</span> <span class="s1">&#39;Compilation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cpy&#39;</span><span class="o">:</span> <span class="s1">&#39;Copyright&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cprt&#39;</span><span class="o">:</span> <span class="s1">&#39;Copyright&#39;</span><span class="p">,</span>
    <span class="s1">&#39;desc&#39;</span><span class="o">:</span> <span class="s1">&#39;Description&#39;</span><span class="p">,</span>
    <span class="s1">&#39;disk&#39;</span><span class="o">:</span> <span class="s1">&#39;Disk Number&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gen&#39;</span><span class="o">:</span> <span class="s1">&#39;Genre&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gnre&#39;</span><span class="o">:</span> <span class="s1">&#39;Genre&#39;</span><span class="p">,</span>
    <span class="s1">&#39;grp&#39;</span><span class="o">:</span> <span class="s1">&#39;Grouping&#39;</span><span class="p">,</span>
    <span class="s1">&#39;isr&#39;</span><span class="o">:</span> <span class="s1">&#39;ISRC Code&#39;</span><span class="p">,</span>
    <span class="s1">&#39;keyw&#39;</span><span class="o">:</span> <span class="s1">&#39;Keyword&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lab&#39;</span><span class="o">:</span> <span class="s1">&#39;Record Label&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lyr&#39;</span><span class="o">:</span> <span class="s1">&#39;Lyrics&#39;</span><span class="p">,</span>
    <span class="s1">&#39;nam&#39;</span><span class="o">:</span> <span class="s1">&#39;Title&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pcst&#39;</span><span class="o">:</span> <span class="s1">&#39;Podcast&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pgap&#39;</span><span class="o">:</span> <span class="s1">&#39;Gapless&#39;</span><span class="p">,</span>
    <span class="s1">&#39;phg&#39;</span><span class="o">:</span> <span class="s1">&#39;Recording Copyright&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prd&#39;</span><span class="o">:</span> <span class="s1">&#39;Producer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prf&#39;</span><span class="o">:</span> <span class="s1">&#39;Performers&#39;</span><span class="p">,</span>
    <span class="s1">&#39;purl&#39;</span><span class="o">:</span> <span class="s1">&#39;Podcast URL&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rtng&#39;</span><span class="o">:</span> <span class="s1">&#39;Rating&#39;</span><span class="p">,</span>
    <span class="s1">&#39;swf&#39;</span><span class="o">:</span> <span class="s1">&#39;Songwriter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tmpo&#39;</span><span class="o">:</span> <span class="s1">&#39;Tempo&#39;</span><span class="p">,</span>
    <span class="s1">&#39;too&#39;</span><span class="o">:</span> <span class="s1">&#39;Encoder&#39;</span><span class="p">,</span>
    <span class="s1">&#39;trkn&#39;</span><span class="o">:</span> <span class="s1">&#39;Track Number&#39;</span><span class="p">,</span>
    <span class="s1">&#39;wrt&#39;</span><span class="o">:</span> <span class="s1">&#39;Composer&#39;</span>
  <span class="p">};</span>

  <span class="nx">genres</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="s2">&quot;Classic Rock&quot;</span><span class="p">,</span> <span class="s2">&quot;Country&quot;</span><span class="p">,</span> <span class="s2">&quot;Dance&quot;</span><span class="p">,</span> <span class="s2">&quot;Disco&quot;</span><span class="p">,</span> <span class="s2">&quot;Funk&quot;</span><span class="p">,</span> <span class="s2">&quot;Grunge&quot;</span><span class="p">,</span> <span class="s2">&quot;Hip-Hop&quot;</span><span class="p">,</span> <span class="s2">&quot;Jazz&quot;</span><span class="p">,</span> <span class="s2">&quot;Metal&quot;</span><span class="p">,</span> <span class="s2">&quot;New Age&quot;</span><span class="p">,</span> <span class="s2">&quot;Oldies&quot;</span><span class="p">,</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;Pop&quot;</span><span class="p">,</span> <span class="s2">&quot;R&amp;B&quot;</span><span class="p">,</span> <span class="s2">&quot;Rap&quot;</span><span class="p">,</span> <span class="s2">&quot;Reggae&quot;</span><span class="p">,</span> <span class="s2">&quot;Rock&quot;</span><span class="p">,</span> <span class="s2">&quot;Techno&quot;</span><span class="p">,</span> <span class="s2">&quot;Industrial&quot;</span><span class="p">,</span> <span class="s2">&quot;Alternative&quot;</span><span class="p">,</span> <span class="s2">&quot;Ska&quot;</span><span class="p">,</span> <span class="s2">&quot;Death Metal&quot;</span><span class="p">,</span> <span class="s2">&quot;Pranks&quot;</span><span class="p">,</span> <span class="s2">&quot;Soundtrack&quot;</span><span class="p">,</span> <span class="s2">&quot;Euro-Techno&quot;</span><span class="p">,</span> <span class="s2">&quot;Ambient&quot;</span><span class="p">,</span> <span class="s2">&quot;Trip-Hop&quot;</span><span class="p">,</span> <span class="s2">&quot;Vocal&quot;</span><span class="p">,</span> <span class="s2">&quot;Jazz+Funk&quot;</span><span class="p">,</span> <span class="s2">&quot;Fusion&quot;</span><span class="p">,</span> <span class="s2">&quot;Trance&quot;</span><span class="p">,</span> <span class="s2">&quot;Classical&quot;</span><span class="p">,</span> <span class="s2">&quot;Instrumental&quot;</span><span class="p">,</span> <span class="s2">&quot;Acid&quot;</span><span class="p">,</span> <span class="s2">&quot;House&quot;</span><span class="p">,</span> <span class="s2">&quot;Game&quot;</span><span class="p">,</span> <span class="s2">&quot;Sound Clip&quot;</span><span class="p">,</span> <span class="s2">&quot;Gospel&quot;</span><span class="p">,</span> <span class="s2">&quot;Noise&quot;</span><span class="p">,</span> <span class="s2">&quot;AlternRock&quot;</span><span class="p">,</span> <span class="s2">&quot;Bass&quot;</span><span class="p">,</span> <span class="s2">&quot;Soul&quot;</span><span class="p">,</span> <span class="s2">&quot;Punk&quot;</span><span class="p">,</span> <span class="s2">&quot;Space&quot;</span><span class="p">,</span> <span class="s2">&quot;Meditative&quot;</span><span class="p">,</span> <span class="s2">&quot;Instrumental Pop&quot;</span><span class="p">,</span> <span class="s2">&quot;Instrumental Rock&quot;</span><span class="p">,</span> <span class="s2">&quot;Ethnic&quot;</span><span class="p">,</span> <span class="s2">&quot;Gothic&quot;</span><span class="p">,</span> <span class="s2">&quot;Darkwave&quot;</span><span class="p">,</span> <span class="s2">&quot;Techno-Industrial&quot;</span><span class="p">,</span> <span class="s2">&quot;Electronic&quot;</span><span class="p">,</span> <span class="s2">&quot;Pop-Folk&quot;</span><span class="p">,</span> <span class="s2">&quot;Eurodance&quot;</span><span class="p">,</span> <span class="s2">&quot;Dream&quot;</span><span class="p">,</span> <span class="s2">&quot;Southern Rock&quot;</span><span class="p">,</span> <span class="s2">&quot;Comedy&quot;</span><span class="p">,</span> <span class="s2">&quot;Cult&quot;</span><span class="p">,</span> <span class="s2">&quot;Gangsta&quot;</span><span class="p">,</span> <span class="s2">&quot;Top 40&quot;</span><span class="p">,</span> <span class="s2">&quot;Christian Rap&quot;</span><span class="p">,</span> <span class="s2">&quot;Pop/Funk&quot;</span><span class="p">,</span> <span class="s2">&quot;Jungle&quot;</span><span class="p">,</span> <span class="s2">&quot;Native American&quot;</span><span class="p">,</span> <span class="s2">&quot;Cabaret&quot;</span><span class="p">,</span> <span class="s2">&quot;New Wave&quot;</span><span class="p">,</span> <span class="s2">&quot;Psychadelic&quot;</span><span class="p">,</span> <span class="s2">&quot;Rave&quot;</span><span class="p">,</span> <span class="s2">&quot;Showtunes&quot;</span><span class="p">,</span> <span class="s2">&quot;Trailer&quot;</span><span class="p">,</span> <span class="s2">&quot;Lo-Fi&quot;</span><span class="p">,</span> <span class="s2">&quot;Tribal&quot;</span><span class="p">,</span> <span class="s2">&quot;Acid Punk&quot;</span><span class="p">,</span> <span class="s2">&quot;Acid Jazz&quot;</span><span class="p">,</span> <span class="s2">&quot;Polka&quot;</span><span class="p">,</span> <span class="s2">&quot;Retro&quot;</span><span class="p">,</span> <span class="s2">&quot;Musical&quot;</span><span class="p">,</span> <span class="s2">&quot;Rock &amp; Roll&quot;</span><span class="p">,</span> <span class="s2">&quot;Hard Rock&quot;</span><span class="p">,</span> <span class="s2">&quot;Folk&quot;</span><span class="p">,</span> <span class="s2">&quot;Folk/Rock&quot;</span><span class="p">,</span> <span class="s2">&quot;National Folk&quot;</span><span class="p">,</span> <span class="s2">&quot;Swing&quot;</span><span class="p">,</span> <span class="s2">&quot;Fast Fusion&quot;</span><span class="p">,</span> <span class="s2">&quot;Bebob&quot;</span><span class="p">,</span> <span class="s2">&quot;Latin&quot;</span><span class="p">,</span> <span class="s2">&quot;Revival&quot;</span><span class="p">,</span> <span class="s2">&quot;Celtic&quot;</span><span class="p">,</span> <span class="s2">&quot;Bluegrass&quot;</span><span class="p">,</span> <span class="s2">&quot;Avantgarde&quot;</span><span class="p">,</span> <span class="s2">&quot;Gothic Rock&quot;</span><span class="p">,</span> <span class="s2">&quot;Progressive Rock&quot;</span><span class="p">,</span> <span class="s2">&quot;Psychedelic Rock&quot;</span><span class="p">,</span> <span class="s2">&quot;Symphonic Rock&quot;</span><span class="p">,</span> <span class="s2">&quot;Slow Rock&quot;</span><span class="p">,</span> <span class="s2">&quot;Big Band&quot;</span><span class="p">,</span> <span class="s2">&quot;Chorus&quot;</span><span class="p">,</span> <span class="s2">&quot;Easy Listening&quot;</span><span class="p">,</span> <span class="s2">&quot;Acoustic&quot;</span><span class="p">,</span> <span class="s2">&quot;Humour&quot;</span><span class="p">,</span> <span class="s2">&quot;Speech&quot;</span><span class="p">,</span> <span class="s2">&quot;Chanson&quot;</span><span class="p">,</span> <span class="s2">&quot;Opera&quot;</span><span class="p">,</span> <span class="s2">&quot;Chamber Music&quot;</span><span class="p">,</span> <span class="s2">&quot;Sonata&quot;</span><span class="p">,</span> <span class="s2">&quot;Symphony&quot;</span><span class="p">,</span> <span class="s2">&quot;Booty Bass&quot;</span><span class="p">,</span> <span class="s2">&quot;Primus&quot;</span><span class="p">,</span> <span class="s2">&quot;Porn Groove&quot;</span><span class="p">,</span> <span class="s2">&quot;Satire&quot;</span><span class="p">,</span> <span class="s2">&quot;Slow Jam&quot;</span><span class="p">,</span> <span class="s2">&quot;Club&quot;</span><span class="p">,</span> <span class="s2">&quot;Tango&quot;</span><span class="p">,</span> <span class="s2">&quot;Samba&quot;</span><span class="p">,</span> <span class="s2">&quot;Folklore&quot;</span><span class="p">,</span> <span class="s2">&quot;Ballad&quot;</span><span class="p">,</span> <span class="s2">&quot;Power Ballad&quot;</span><span class="p">,</span> <span class="s2">&quot;Rhythmic Soul&quot;</span><span class="p">,</span> <span class="s2">&quot;Freestyle&quot;</span><span class="p">,</span> <span class="s2">&quot;Duet&quot;</span><span class="p">,</span> <span class="s2">&quot;Punk Rock&quot;</span><span class="p">,</span> <span class="s2">&quot;Drum Solo&quot;</span><span class="p">,</span> <span class="s2">&quot;A Capella&quot;</span><span class="p">,</span> <span class="s2">&quot;Euro-House&quot;</span><span class="p">,</span> <span class="s2">&quot;Dance Hall&quot;</span><span class="p">];</span>

  <span class="nx">M4ADemuxer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readChunk</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">diff</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">entryCount</span><span class="p">,</span> <span class="nx">field</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">numEntries</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">rating</span><span class="p">,</span> <span class="nx">sampleRate</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">readHeaders</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">()</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">readHeaders</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="k">in</span> <span class="nx">metafields</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">metafield</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">readHeaders</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;ftyp&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;M4A &#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Not a valid M4A file.&#39;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;moov&#39;</span><span class="o">:</span>
        <span class="k">case</span> <span class="s1">&#39;trak&#39;</span><span class="o">:</span>
        <span class="k">case</span> <span class="s1">&#39;mdia&#39;</span><span class="o">:</span>
        <span class="k">case</span> <span class="s1">&#39;minf&#39;</span><span class="o">:</span>
        <span class="k">case</span> <span class="s1">&#39;stbl&#39;</span><span class="o">:</span>
        <span class="k">case</span> <span class="s1">&#39;udta&#39;</span><span class="o">:</span>
        <span class="k">case</span> <span class="s1">&#39;ilst&#39;</span><span class="o">:</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;stco&#39;</span><span class="o">:</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
          <span class="nx">entryCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">chunkOffsets</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">entryCount</span> <span class="o">?</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">entryCount</span> <span class="o">:</span> <span class="nx">_i</span> <span class="o">&gt;</span> <span class="nx">entryCount</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">entryCount</span> <span class="o">?</span> <span class="o">++</span><span class="nx">_i</span> <span class="o">:</span> <span class="o">--</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">chunkOffsets</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;meta&#39;</span><span class="o">:</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">metadata</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">metaMaxPos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;data&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">field</span> <span class="o">=</span> <span class="nx">metafields</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">metafield</span><span class="p">];</span>
          <span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">metafield</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;disk&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;trkn&#39;</span><span class="o">:</span>
              <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">offset</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; of &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">-</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">offset</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">));</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;cpil&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;pgap&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;pcst&#39;</span><span class="o">:</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">()</span> <span class="o">===</span> <span class="mi">1</span><span class="p">;</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;gnre&#39;</span><span class="o">:</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">genres</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;rtng&#39;</span><span class="o">:</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
              <span class="nx">rating</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rating</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">?</span> <span class="s1">&#39;Clean&#39;</span> <span class="o">:</span> <span class="nx">rating</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;Explicit&#39;</span> <span class="o">:</span> <span class="s1">&#39;None&#39;</span><span class="p">;</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;tmpo&#39;</span><span class="o">:</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">();</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;covr&#39;</span><span class="o">:</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readBuffer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">metadata</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUTF8</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;mdhd&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
          <span class="nx">sampleRate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
          <span class="nx">duration</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="nx">duration</span> <span class="o">/</span> <span class="nx">sampleRate</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;stsd&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
          <span class="nx">numEntries</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">numEntries</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s2">&quot;Only expecting one entry in sample description atom!&quot;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">formatID</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">()</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown version in stsd atom.&#39;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">channelsPerFrame</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bitsPerChannel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;alac&#39;</span><span class="o">:</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readBuffer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">sentCookie</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dataSections</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">sendDataSections</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;esds&#39;</span><span class="o">:</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">readEsds</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">sentCookie</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dataSections</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">sendDataSections</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;mdat&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">chunkOffsets</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">offset</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">chunkOffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">diff</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">chunkOffsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">offset</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="nx">diff</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">-=</span> <span class="nx">diff</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">buffer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readSingleBuffer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">-=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">readHeaders</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sentCookie</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dataSections</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">dataSections</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">dataSections</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">buffer</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">offset</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">metaMaxPos</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">metadata</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;mdat&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">readHeaders</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">M4ADemuxer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sendDataSections</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">interval</span><span class="p">,</span>
      <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">interval</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">_this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">dataSections</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">dataSections</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">dataSections</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">interval</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="mi">100</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">M4ADemuxer</span><span class="p">.</span><span class="nx">readDescrLen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">len</span><span class="p">;</span>
    <span class="nx">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">();</span>
      <span class="nx">len</span> <span class="o">=</span> <span class="p">(</span><span class="nx">len</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">c</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">len</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">readDescr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tag</span><span class="p">;</span>
    <span class="nx">tag</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">();</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">M4ADemuxer</span><span class="p">.</span><span class="nx">readDescrLen</span><span class="p">(</span><span class="nx">stream</span><span class="p">)];</span>
  <span class="p">};</span>

  <span class="nx">M4ADemuxer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readEsds</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">codec_id</span><span class="p">,</span> <span class="nx">extra</span><span class="p">,</span> <span class="nx">flags</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">startPos</span><span class="p">,</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">,</span> <span class="nx">_ref1</span><span class="p">,</span> <span class="nx">_ref2</span><span class="p">;</span>
    <span class="nx">startPos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">offset</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
    <span class="nx">_ref</span> <span class="o">=</span> <span class="nx">readDescr</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">),</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">_ref</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">===</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      <span class="nx">flags</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">flags</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">flags</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">());</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">flags</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">_ref1</span> <span class="o">=</span> <span class="nx">readDescr</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">),</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">_ref1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">_ref1</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">===</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">codec_id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
      <span class="nx">_ref2</span> <span class="o">=</span> <span class="nx">readDescr</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">),</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">_ref2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">_ref2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">===</span> <span class="mh">0x05</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;cookie&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readBuffer</span><span class="p">(</span><span class="nx">len</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">extra</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+</span> <span class="nx">startPos</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="nx">extra</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">M4ADemuxer</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Demuxer</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">AIFFDemuxer</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">AIFFDemuxer</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">AIFFDemuxer</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">AIFFDemuxer</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">AIFFDemuxer</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">Demuxer</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">AIFFDemuxer</span><span class="p">);</span>

  <span class="nx">AIFFDemuxer</span><span class="p">.</span><span class="nx">probe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">peekString</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;FORM&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">_ref</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">peekString</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">===</span> <span class="s1">&#39;AIFF&#39;</span> <span class="o">||</span> <span class="nx">_ref</span> <span class="o">===</span> <span class="s1">&#39;AIFC&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">AIFFDemuxer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readChunk</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">readStart</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;FORM&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid AIFF.&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fileSize</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fileType</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">readStart</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">_ref</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fileType</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;AIFF&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">_ref</span> <span class="o">!==</span> <span class="s1">&#39;AIFC&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid AIFF.&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">readHeaders</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;COMM&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">formatID</span><span class="o">:</span> <span class="s1">&#39;lpcm&#39;</span><span class="p">,</span>
            <span class="nx">channelsPerFrame</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">(),</span>
            <span class="nx">sampleCount</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">(),</span>
            <span class="nx">bitsPerChannel</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">(),</span>
            <span class="nx">sampleRate</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readFloat80</span><span class="p">()</span>
          <span class="p">};</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fileType</span> <span class="o">===</span> <span class="s1">&#39;AIFC&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">format</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">format</span> <span class="o">===</span> <span class="s1">&#39;twos&#39;</span> <span class="o">||</span> <span class="nx">format</span> <span class="o">===</span> <span class="s1">&#39;sowt&#39;</span> <span class="o">||</span> <span class="nx">format</span> <span class="o">===</span> <span class="s1">&#39;fl32&#39;</span> <span class="o">||</span> <span class="nx">format</span> <span class="o">===</span> <span class="s1">&#39;fl64&#39;</span> <span class="o">||</span> <span class="nx">format</span> <span class="o">===</span> <span class="s1">&#39;NONE&#39;</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">format</span> <span class="o">=</span> <span class="s1">&#39;lpcm&#39;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">formatID</span> <span class="o">=</span> <span class="nx">format</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">littleEndian</span> <span class="o">=</span> <span class="nx">format</span> <span class="o">===</span> <span class="s1">&#39;sowt&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">floatingPoint</span> <span class="o">=</span> <span class="nx">format</span> <span class="o">===</span> <span class="s1">&#39;fl32&#39;</span> <span class="o">||</span> <span class="nx">format</span> <span class="o">===</span> <span class="s1">&#39;fl64&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">18</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">sampleCount</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;SSND&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readSSNDHeader</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
            <span class="nx">offset</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="nx">offset</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">readSSNDHeader</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">buffer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readSingleBuffer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">-=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">readHeaders</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;SSND&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">readHeaders</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">AIFFDemuxer</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Demuxer</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">WAVEDemuxer</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">WAVEDemuxer</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">formats</span><span class="p">;</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">WAVEDemuxer</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">WAVEDemuxer</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">WAVEDemuxer</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">Demuxer</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">WAVEDemuxer</span><span class="p">);</span>

  <span class="nx">WAVEDemuxer</span><span class="p">.</span><span class="nx">probe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">peekString</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;RIFF&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">peekString</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;WAVE&#39;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">formats</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x0001</span><span class="o">:</span> <span class="s1">&#39;lpcm&#39;</span><span class="p">,</span>
    <span class="mh">0x0003</span><span class="o">:</span> <span class="s1">&#39;lpcm&#39;</span><span class="p">,</span>
    <span class="mh">0x0006</span><span class="o">:</span> <span class="s1">&#39;alaw&#39;</span><span class="p">,</span>
    <span class="mh">0x0007</span><span class="o">:</span> <span class="s1">&#39;ulaw&#39;</span>
  <span class="p">};</span>

  <span class="nx">WAVEDemuxer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readChunk</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">readStart</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;RIFF&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid WAV file.&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fileSize</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">readStart</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;WAVE&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid WAV file.&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">readHeaders</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;fmt &#39;</span><span class="o">:</span>
          <span class="nx">encoding</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">encoding</span> <span class="k">in</span> <span class="nx">formats</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Unsupported format in WAV file.&#39;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">formatID</span><span class="o">:</span> <span class="nx">formats</span><span class="p">[</span><span class="nx">encoding</span><span class="p">],</span>
            <span class="nx">floatingPoint</span><span class="o">:</span> <span class="nx">encoding</span> <span class="o">===</span> <span class="mh">0x0003</span><span class="p">,</span>
            <span class="nx">littleEndian</span><span class="o">:</span> <span class="nx">formats</span><span class="p">[</span><span class="nx">encoding</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;lpcm&#39;</span><span class="p">,</span>
            <span class="nx">channelsPerFrame</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
            <span class="nx">sampleRate</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
          <span class="p">};</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bitsPerChannel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitsPerChannel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt16</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;data&#39;</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">sentDuration</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">bytes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bitsPerChannel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">/</span> <span class="nx">bytes</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">channelsPerFrame</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">sentDuration</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">buffer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readSingleBuffer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">-=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">readHeaders</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">len</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">advance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">len</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">readHeaders</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">WAVEDemuxer</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Demuxer</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">AUDemuxer</span><span class="p">,</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">AUDemuxer</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">bps</span><span class="p">,</span> <span class="nx">formats</span><span class="p">;</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">AUDemuxer</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">AUDemuxer</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">AUDemuxer</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">Demuxer</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">AUDemuxer</span><span class="p">);</span>

  <span class="nx">AUDemuxer</span><span class="p">.</span><span class="nx">probe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">peekString</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;.snd&#39;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">bps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">];</span>

  <span class="nx">bps</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

  <span class="nx">formats</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="o">:</span> <span class="s1">&#39;ulaw&#39;</span><span class="p">,</span>
    <span class="mi">27</span><span class="o">:</span> <span class="s1">&#39;alaw&#39;</span>
  <span class="p">};</span>

  <span class="nx">AUDemuxer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readChunk</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buf</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">,</span> <span class="nx">dataSize</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">readHeader</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readString</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;.snd&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid AU file.&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
      <span class="nx">dataSize</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
      <span class="nx">encoding</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">formatID</span><span class="o">:</span> <span class="nx">formats</span><span class="p">[</span><span class="nx">encoding</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;lpcm&#39;</span><span class="p">,</span>
        <span class="nx">floatingPoint</span><span class="o">:</span> <span class="nx">encoding</span> <span class="o">===</span> <span class="mi">6</span> <span class="o">||</span> <span class="nx">encoding</span> <span class="o">===</span> <span class="mi">7</span><span class="p">,</span>
        <span class="nx">bitsPerChannel</span><span class="o">:</span> <span class="nx">bps</span><span class="p">[</span><span class="nx">encoding</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
        <span class="nx">sampleRate</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">(),</span>
        <span class="nx">channelsPerFrame</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt32</span><span class="p">()</span>
      <span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bitsPerChannel</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Unsupported encoding in AU file.&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">dataSize</span> <span class="o">!==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">bytes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bitsPerChannel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="nx">dataSize</span> <span class="o">/</span> <span class="nx">bytes</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">channelsPerFrame</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">sampleRate</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">readHeader</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readHeader</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">available</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">buf</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readSingleBuffer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">remainingBytes</span><span class="p">());</span>
        <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">buf</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">remainingBytes</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">AUDemuxer</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Demuxer</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">LPCMDecoder</span><span class="p">,</span>
  <span class="nx">__bind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">me</span><span class="p">){</span> <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span> <span class="p">},</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">LPCMDecoder</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">LPCMDecoder</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">LPCMDecoder</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">readChunk</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readChunk</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">LPCMDecoder</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">Decoder</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;lpcm&#39;</span><span class="p">,</span> <span class="nx">LPCMDecoder</span><span class="p">);</span>

  <span class="nx">LPCMDecoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">floatingPoint</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">floatingPoint</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">LPCMDecoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readChunk</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">chunkSize</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">littleEndian</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">samples</span><span class="p">,</span> <span class="nx">stream</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_j</span><span class="p">,</span> <span class="nx">_k</span><span class="p">,</span> <span class="nx">_l</span><span class="p">,</span> <span class="nx">_m</span><span class="p">,</span> <span class="nx">_n</span><span class="p">;</span>
    <span class="nx">stream</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">;</span>
    <span class="nx">littleEndian</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">littleEndian</span><span class="p">;</span>
    <span class="nx">chunkSize</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">remainingBytes</span><span class="p">());</span>
    <span class="nx">samples</span> <span class="o">=</span> <span class="nx">chunkSize</span> <span class="o">/</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bitsPerChannel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">chunkSize</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;available&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">readChunk</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">floatingPoint</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bitsPerChannel</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">32</span><span class="o">:</span>
          <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">samples</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">samples</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">readFloat32</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">64</span><span class="o">:</span>
          <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">samples</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_j</span> <span class="o">&lt;</span> <span class="nx">samples</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_j</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">readFloat64</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Unsupported bit depth.&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bitsPerChannel</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">8</span><span class="o">:</span>
          <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int8Array</span><span class="p">(</span><span class="nx">samples</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_k</span> <span class="o">&lt;</span> <span class="nx">samples</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_k</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">readInt8</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">16</span><span class="o">:</span>
          <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int16Array</span><span class="p">(</span><span class="nx">samples</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_l</span> <span class="o">&lt;</span> <span class="nx">samples</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_l</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">readInt16</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">24</span><span class="o">:</span>
          <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int32Array</span><span class="p">(</span><span class="nx">samples</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_m</span> <span class="o">&lt;</span> <span class="nx">samples</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_m</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">readInt24</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">32</span><span class="o">:</span>
          <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int32Array</span><span class="p">(</span><span class="nx">samples</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_n</span> <span class="o">&lt;</span> <span class="nx">samples</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_n</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">readInt32</span><span class="p">(</span><span class="nx">littleEndian</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Unsupported bit depth.&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">LPCMDecoder</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Decoder</span><span class="p">);</span>



<span class="kd">var</span> <span class="nx">XLAWDecoder</span><span class="p">,</span>
  <span class="nx">__bind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">me</span><span class="p">){</span> <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span> <span class="p">},</span>
  <span class="nx">__hasProp</span> <span class="o">=</span> <span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">,</span>
  <span class="nx">__extends</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__hasProp</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">}</span> <span class="kd">function</span> <span class="nx">ctor</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span> <span class="p">}</span> <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">();</span> <span class="nx">child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="k">return</span> <span class="nx">child</span><span class="p">;</span> <span class="p">};</span>

<span class="nx">XLAWDecoder</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_super</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">BIAS</span><span class="p">,</span> <span class="nx">QUANT_MASK</span><span class="p">,</span> <span class="nx">SEG_MASK</span><span class="p">,</span> <span class="nx">SEG_SHIFT</span><span class="p">,</span> <span class="nx">SIGN_BIT</span><span class="p">;</span>

  <span class="nx">__extends</span><span class="p">(</span><span class="nx">XLAWDecoder</span><span class="p">,</span> <span class="nx">_super</span><span class="p">);</span>

  <span class="nx">Decoder</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;ulaw&#39;</span><span class="p">,</span> <span class="nx">XLAWDecoder</span><span class="p">);</span>

  <span class="nx">Decoder</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;alaw&#39;</span><span class="p">,</span> <span class="nx">XLAWDecoder</span><span class="p">);</span>

  <span class="nx">SIGN_BIT</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

  <span class="nx">QUANT_MASK</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>

  <span class="nx">SEG_SHIFT</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

  <span class="nx">SEG_MASK</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>

  <span class="nx">BIAS</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">XLAWDecoder</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">readChunk</span> <span class="o">=</span> <span class="nx">__bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readChunk</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">seg</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">table</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_j</span><span class="p">;</span>
    <span class="nx">XLAWDecoder</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bitsPerChannel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">table</span> <span class="o">=</span> <span class="nx">table</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">formatID</span> <span class="o">===</span> <span class="s1">&#39;ulaw&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">++</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">val</span> <span class="o">=</span> <span class="o">~</span><span class="nx">i</span><span class="p">;</span>
        <span class="nx">t</span> <span class="o">=</span> <span class="p">((</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="nx">QUANT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="nx">BIAS</span><span class="p">;</span>
        <span class="nx">t</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="nx">SEG_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="nx">SEG_SHIFT</span><span class="p">;</span>
        <span class="nx">table</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span> <span class="o">&amp;</span> <span class="nx">SIGN_BIT</span> <span class="o">?</span> <span class="nx">BIAS</span> <span class="o">-</span> <span class="nx">t</span> <span class="o">:</span> <span class="nx">t</span> <span class="o">-</span> <span class="nx">BIAS</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_j</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">++</span><span class="nx">_j</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">val</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">^</span> <span class="mh">0x55</span><span class="p">;</span>
        <span class="nx">t</span> <span class="o">=</span> <span class="nx">val</span> <span class="o">&amp;</span> <span class="nx">QUANT_MASK</span><span class="p">;</span>
        <span class="nx">seg</span> <span class="o">=</span> <span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="nx">SEG_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="nx">SEG_SHIFT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">seg</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t</span> <span class="o">+</span> <span class="nx">t</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nx">seg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t</span> <span class="o">+</span> <span class="nx">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">table</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span> <span class="o">&amp;</span> <span class="nx">SIGN_BIT</span> <span class="o">?</span> <span class="nx">t</span> <span class="o">:</span> <span class="o">-</span><span class="nx">t</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">XLAWDecoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">readChunk</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">chunkSize</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">samples</span><span class="p">,</span> <span class="nx">stream</span><span class="p">,</span> <span class="nx">table</span><span class="p">,</span> <span class="nx">_i</span><span class="p">;</span>
    <span class="nx">stream</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">table</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">;</span>
    <span class="nx">chunkSize</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">remainingBytes</span><span class="p">());</span>
    <span class="nx">samples</span> <span class="o">=</span> <span class="nx">chunkSize</span> <span class="o">/</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">bitsPerChannel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">chunkSize</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;available&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">readChunk</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int16Array</span><span class="p">(</span><span class="nx">samples</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">samples</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">output</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">table</span><span class="p">[</span><span class="nx">stream</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">()];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">XLAWDecoder</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Decoder</span><span class="p">);</span>

</pre></div></td></tr></tbody></table><div id="projectname"><a href="../../../index.html">JukeboxJS</a></div></div></body></html>
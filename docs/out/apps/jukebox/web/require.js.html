<!DOCTYPE html><html><head><title>require.js</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../../index.html" class="source"><span class="file_name">README</span></a><a href="../../../apps/jukebox/web/moment.min.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">moment.min.js</span></a><a href="../../../apps/jukebox/web/backbone.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">backbone.js</span></a><a href="../../../apps/jukebox/web/chat.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">chat.js</span></a><a href="../../../apps/jukebox/web/mp3.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">mp3.js</span></a><a href="../../../apps/jukebox/web/jsmad.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">jsmad.js</span></a><a href="../../../apps/jukebox/web/require.js.html" class="source selected"><span class="base_path">apps / jukebox / web / </span><span class="file_name">require.js</span></a><a href="../../../apps/jukebox/web/houseChat.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">houseChat.js</span></a><a href="../../../apps/jukebox/web/houseAuth.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">houseAuth.js</span></a><a href="../../../apps/jukebox/web/jukebox.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">jukebox.js</span></a><a href="../../../apps/jukebox/web/dancer.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">dancer.js</span></a><a href="../../../apps/jukebox/web/jquery.idle-timer.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">jquery.idle-timer.js</span></a><a href="../../../apps/jukebox/web/aac.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">aac.js</span></a><a href="../../../apps/jukebox/web/aurora.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">aurora.js</span></a><a href="../../../apps/jukebox/web/jquery.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">jquery.js</span></a><a href="../../../apps/jukebox/web/houseSongs.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">houseSongs.js</span></a><a href="../../../apps/jukebox/web/jquery.ui.min.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">jquery.ui.min.js</span></a><a href="../../../apps/jukebox/web/chart.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">chart.js</span></a><a href="../../../apps/jukebox/web/backbone-house.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">backbone-house.js</span></a><a href="../../../apps/jukebox/web/alac.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">alac.js</span></a><a href="../../../apps/jukebox/web/underscore.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">underscore.js</span></a><a href="../../../apps/jukebox/web/pitch.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">pitch.js</span></a><a href="../../../apps/jukebox/web/flac.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">flac.js</span></a><a href="../../../apps/jukebox/web/id3v2.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">id3v2.js</span></a><a href="../../../apps/jukebox/web/index.js.html" class="source "><span class="base_path">apps / jukebox / web / </span><span class="file_name">index.js</span></a><a href="../../../apps/jukebox/config/config.js.html" class="source "><span class="base_path">apps / jukebox / config / </span><span class="file_name">config.js</span></a><a href="../../../apps/jukebox/index.js.html" class="source "><span class="base_path">apps / jukebox / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/songs/index.js.html" class="source "><span class="base_path">endPoints / songs / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/apps/index.js.html" class="source "><span class="base_path">endPoints / apps / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/files/index.js.html" class="source "><span class="base_path">endPoints / files / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/auth/index.js.html" class="source "><span class="base_path">endPoints / auth / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/users/index.js.html" class="source "><span class="base_path">endPoints / users / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/collections/index.js.html" class="source "><span class="base_path">endPoints / collections / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/chat/index.js.html" class="source "><span class="base_path">endPoints / chat / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/songr/index.js.html" class="source "><span class="base_path">endPoints / songr / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/fs/index.js.html" class="source "><span class="base_path">endPoints / fs / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/songq/index.js.html" class="source "><span class="base_path">endPoints / songq / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/artists/index.js.html" class="source "><span class="base_path">endPoints / artists / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/albums/index.js.html" class="source "><span class="base_path">endPoints / albums / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/songp/index.js.html" class="source "><span class="base_path">endPoints / songp / </span><span class="file_name">index.js</span></a><a href="../../../endPoints/index.js.html" class="source "><span class="base_path">endPoints / </span><span class="file_name">index.js</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>require.js</h1><div class="filepath">apps/jukebox/web/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>vim: et:ts=4:sw=4:sts=4</p></div><div class="details"></div><div class="body"></div></div><div class="dox"><div class="summary"><p>slint regexp: true, nomen: true</p></div><div class="body"></div></div><div class="dox"><div class="summary"><p>lobal window, navigator, document, importScripts, jQuery, setTimeout, opera</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">requirejs</span><span class="p">,</span> <span class="nx">require</span><span class="p">,</span> <span class="nx">define</span><span class="p">;</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">global</span><span class="p">)</span> <span class="p">{</span>
    <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">version</span> <span class="o">=</span> <span class="s1">&#39;2.0.0&#39;</span><span class="p">,</span>
        <span class="nx">commentRegExp</span> <span class="o">=</span> <span class="sr">/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/mg</span><span class="p">,</span>
        <span class="nx">cjsRequireRegExp</span> <span class="o">=</span> <span class="sr">/require\s*\(\s*[&quot;&#39;]([^&#39;&quot;\s]+)[&quot;&#39;]\s*\)/g</span><span class="p">,</span>
        <span class="nx">jsSuffixRegExp</span> <span class="o">=</span> <span class="sr">/\.js$/</span><span class="p">,</span>
        <span class="nx">currDirRegExp</span> <span class="o">=</span> <span class="sr">/^\.\//</span><span class="p">,</span>
        <span class="nx">ostring</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">,</span>
        <span class="nx">ap</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
        <span class="nx">aps</span> <span class="o">=</span> <span class="nx">ap</span><span class="p">.</span><span class="nx">slice</span><span class="p">,</span>
        <span class="nx">apsp</span> <span class="o">=</span> <span class="nx">ap</span><span class="p">.</span><span class="nx">splice</span><span class="p">,</span>
        <span class="nx">isBrowser</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">navigator</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">),</span>
        <span class="nx">isWebWorker</span> <span class="o">=</span> <span class="o">!</span><span class="nx">isBrowser</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">importScripts</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">,</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>PS3 indicates loaded and complete, but need to wait for complete
specifically. Sequence is 'loading', 'loaded', execution,
then 'complete'. The UA check is unfortunate, but not sure how
to feature test w/o causing perf issues.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">readyRegExp</span> <span class="o">=</span> <span class="nx">isBrowser</span> <span class="o">&amp;&amp;</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span> <span class="o">===</span> <span class="s1">&#39;PLAYSTATION 3&#39;</span> <span class="o">?</span>
                      <span class="sr">/^complete$/</span> <span class="o">:</span> <span class="sr">/^(complete|loaded)$/</span><span class="p">,</span>
        <span class="nx">defContextName</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Oh the tragedy, detecting opera. See the usage of isOpera for reason.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">isOpera</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">opera</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">opera</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;[object Opera]&#39;</span><span class="p">,</span>
        <span class="nx">contexts</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">cfg</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">globalDefQueue</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">useInteractive</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">req</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">head</span><span class="p">,</span> <span class="nx">baseElement</span><span class="p">,</span> <span class="nx">dataMain</span><span class="p">,</span> <span class="nx">src</span><span class="p">,</span>
        <span class="nx">interactiveScript</span><span class="p">,</span> <span class="nx">currentlyAddingScript</span><span class="p">,</span> <span class="nx">mainScript</span><span class="p">,</span> <span class="nx">subPath</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">ostring</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Function]&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">ostring</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Array]&#39;</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Helper function for iterating over an array. If the func returns<br />a true value, it will break out of the loop.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">each</span><span class="p">(</span><span class="nx">ary</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ary</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ary</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">func</span><span class="p">(</span><span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ary</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Helper function for iterating over an array backwards. If the func<br />returns a true value, it will break out of the loop.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">eachReverse</span><span class="p">(</span><span class="nx">ary</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ary</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">ary</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">func</span><span class="p">(</span><span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ary</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">hasProp</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prop</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Cycles over properties in an object and calls a function for each<br />property value. If the function returns a truthy value, then the<br />iteration is stopped.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">eachProp</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">prop</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">prop</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prop</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">func</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">prop</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Simple function to mix in properties from source into target,<br />but only if target does not already have a property of the same name.<br />This is not robust in IE for transferring methods that match<br />Object.prototype names, but the uses of mixin here seem unlikely to<br />trigger a problem related to that.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">mixin</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">force</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">eachProp</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">force</span> <span class="o">||</span> <span class="o">!</span><span class="nx">hasProp</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">prop</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">target</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Similar to Function.prototype.bind, but the 'this' object is specified
first, since it is easier to read/figure out what 'this' will be.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">scripts</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Allow getting a global that expressed in
dot notation, like 'a.b.c'.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">getGlobal</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">global</span><span class="p">;</span>
        <span class="nx">each</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">part</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">g</span> <span class="o">=</span> <span class="nx">g</span><span class="p">[</span><span class="nx">part</span><span class="p">];</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">g</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">makeContextModuleFunc</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">,</span> <span class="nx">enableBuildCallback</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>A version of a require function that passes a moduleName
value for items that may need to
look up paths relative to the moduleName</p>
</td><td class="code"><div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">aps</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">lastArg</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">enableBuildCallback</span> <span class="o">&amp;&amp;</span>
                <span class="nx">isFunction</span><span class="p">((</span><span class="nx">lastArg</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])))</span> <span class="p">{</span>
                <span class="nx">lastArg</span><span class="p">.</span><span class="nx">__requireJsBuild</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">relMap</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">addRequireMethods</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">each</span><span class="p">([</span>
            <span class="p">[</span><span class="s1">&#39;toUrl&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;undef&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;defined&#39;</span><span class="p">,</span> <span class="s1">&#39;requireDefined&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;specified&#39;</span><span class="p">,</span> <span class="s1">&#39;requireSpecified&#39;</span><span class="p">]</span>
        <span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">req</span><span class="p">[</span><span class="nx">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">makeContextModuleFunc</span><span class="p">(</span><span class="nx">context</span><span class="p">[</span><span class="nx">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="nx">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="nx">relMap</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Constructs an error with a pointer to an URL with more information.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>id </span><span class="dox_type">String</span><span>- the error ID that maps to an ID on a web page.</span></div><div class="dox_tag_detail"><span>message </span><span class="dox_type">String</span><span>- human readable error.</span></div><div class="dox_tag_detail"><span>[err] </span><span class="dox_type">Error</span><span>- the original error, if there is one.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">makeError</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">requireModules</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">msg</span> <span class="o">+</span> <span class="s1">&#39;\nhttp://requirejs.org/docs/errors.html#&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">requireType</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">requireModules</span> <span class="o">=</span> <span class="nx">requireModules</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">e</span><span class="p">.</span><span class="nx">originalError</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>If a define is already in play via another AMD loader,
do not overwrite.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">requirejs</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">requirejs</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Do not overwrite and existing requirejs instance.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">cfg</span> <span class="o">=</span> <span class="nx">requirejs</span><span class="p">;</span>
        <span class="nx">requirejs</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Allow for a require config object</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">require</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">require</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>assume it is a config object.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">cfg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">;</span>
        <span class="nx">require</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">newContext</span><span class="p">(</span><span class="nx">contextName</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">waitSeconds</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
                <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">&#39;./&#39;</span><span class="p">,</span>
                <span class="nx">paths</span><span class="o">:</span> <span class="p">{},</span>
                <span class="nx">pkgs</span><span class="o">:</span> <span class="p">{},</span>
                <span class="nx">shim</span><span class="o">:</span> <span class="p">{}</span>
            <span class="p">},</span>
            <span class="nx">registry</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">undefEvents</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">defQueue</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">defined</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">urlMap</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">urlFetched</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">requireCounter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nx">unnormalizedCounter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Used to track the order in which modules
should be executed, by the order they
load. Important for consistent cycle resolution
behavior.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">waitAry</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">inCheckLoaded</span><span class="p">,</span> <span class="nx">Module</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">handlers</span><span class="p">,</span>
            <span class="nx">checkLoadedTimeoutId</span><span class="p">;</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Trims the . and .. from an array of path segments.<br />It will keep a leading path segment if a .. will become<br />the first path segment, to help with module name lookups,<br />which act like paths, but can be remapped. But the end result,<br />all paths that use this function should look normalized.<br />NOTE: this method MODIFIES the input array.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>ary </span><span class="dox_type">Array</span><span>- the array of path segments.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">trimDots</span><span class="p">(</span><span class="nx">ary</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">part</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="nx">i</span><span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">part</span> <span class="o">=</span> <span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">part</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">ary</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">part</span> <span class="o">===</span> <span class="s1">&#39;..&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">ary</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;..&#39;</span> <span class="o">||</span> <span class="nx">ary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;..&#39;</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>End of the line. Keep at least one non-dot
path segment at the front so it can be mapped
correctly to disk. Otherwise, there is likely
no path mapping for a path starting with '..'.
This can still fail, but catches the most reasonable
uses of ..</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">ary</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
                        <span class="nx">i</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Given a relative module name, like ./something, normalize it to<br />a real name that can be mapped to a path.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>name </span><span class="dox_type">String</span><span>- the relative name</span></div><div class="dox_tag_detail"><span>baseName </span><span class="dox_type">String</span><span>- a real name that the name arg is relative</span></div><div class="dox_tag_detail"><span>applyMap </span><span class="dox_type">Boolean</span><span>- apply the map config to the value. Should</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">baseName</span><span class="p">,</span> <span class="nx">applyMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">baseParts</span> <span class="o">=</span> <span class="nx">baseName</span> <span class="o">&amp;&amp;</span> <span class="nx">baseName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
                <span class="nx">map</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span>
                <span class="nx">starMap</span> <span class="o">=</span> <span class="nx">map</span> <span class="o">&amp;&amp;</span> <span class="nx">map</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
                <span class="nx">pkgName</span><span class="p">,</span> <span class="nx">pkgConfig</span><span class="p">,</span> <span class="nx">mapValue</span><span class="p">,</span> <span class="nx">nameParts</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">nameSegment</span><span class="p">,</span>
                <span class="nx">foundMap</span><span class="p">;</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Adjust any relative paths.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>If have a base name, try to normalize against it,
otherwise, assume it is a top-level require that will
be relative to baseUrl in the end.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">baseName</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">pkgs</span><span class="p">[</span><span class="nx">baseName</span><span class="p">])</span> <span class="p">{</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>If the baseName is a package name, then just treat it as one
name to concat the name with.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">baseParts</span> <span class="o">=</span> <span class="p">[</span><span class="nx">baseName</span><span class="p">];</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Convert baseName to array, and lop off the last part,
so that . matches that 'directory' and not name of the baseName's
module. For instance, baseName of 'one/two/three', maps to
'one/two/three.js', but we want the directory, 'one/two' for
this normalization.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">baseParts</span> <span class="o">=</span> <span class="nx">baseParts</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">baseParts</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="nx">name</span> <span class="o">=</span> <span class="nx">baseParts</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">));</span>
                    <span class="nx">trimDots</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>Some use of packages may use a . path to reference the
'main' module name, so normalize for that.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">pkgConfig</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">pkgs</span><span class="p">[(</span><span class="nx">pkgName</span> <span class="o">=</span> <span class="nx">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])];</span>
                    <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">pkgConfig</span> <span class="o">&amp;&amp;</span> <span class="nx">name</span> <span class="o">===</span> <span class="nx">pkgName</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">pkgConfig</span><span class="p">.</span><span class="nx">main</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">name</span> <span class="o">=</span> <span class="nx">pkgName</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>No baseName, so this is ID is resolved relative
to baseUrl, pull off the leading dot.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>Apply map config if available.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">applyMap</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">baseParts</span> <span class="o">||</span> <span class="nx">starMap</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">nameParts</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>

                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">nameParts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">nameSegment</span> <span class="o">=</span> <span class="nx">nameParts</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">baseParts</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>Find the longest baseName segment match in the config.
So, do joins on the biggest to smallest lengths of baseParts.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">baseParts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">mapValue</span> <span class="o">=</span> <span class="nx">map</span><span class="p">[</span><span class="nx">baseParts</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">j</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)];</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>baseName segment has  config, find if it has one for
this name.</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="k">if</span> <span class="p">(</span><span class="nx">mapValue</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">mapValue</span> <span class="o">=</span> <span class="nx">mapValue</span><span class="p">[</span><span class="nx">nameSegment</span><span class="p">];</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">mapValue</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>Match, update name to the new value.</p>
</td><td class="code"><div class="highlight"><pre>                                    <span class="nx">foundMap</span> <span class="o">=</span> <span class="nx">mapValue</span><span class="p">;</span>
                                    <span class="k">break</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">foundMap</span> <span class="o">&amp;&amp;</span> <span class="nx">starMap</span> <span class="o">&amp;&amp;</span> <span class="nx">starMap</span><span class="p">[</span><span class="nx">nameSegment</span><span class="p">])</span> <span class="p">{</span>
                        <span class="nx">foundMap</span> <span class="o">=</span> <span class="nx">starMap</span><span class="p">[</span><span class="nx">nameSegment</span><span class="p">];</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">foundMap</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">nameParts</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">foundMap</span><span class="p">);</span>
                        <span class="nx">name</span> <span class="o">=</span> <span class="nx">nameParts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">removeScript</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">isBrowser</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">each</span><span class="p">(</span><span class="nx">scripts</span><span class="p">(),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">scriptNode</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">scriptNode</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-requiremodule&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">name</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">scriptNode</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-requirecontext&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">context</span><span class="p">.</span><span class="nx">contextName</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">scriptNode</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">scriptNode</span><span class="p">);</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">hasPathFallback</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pathConfig</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">paths</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pathConfig</span> <span class="o">&amp;&amp;</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">pathConfig</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">pathConfig</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">removeScript</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>Pop off the first array value, since it failed, and
retry</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">pathConfig</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
                <span class="nx">context</span><span class="p">.</span><span class="nx">undef</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
                <span class="nx">context</span><span class="p">.</span><span class="nx">require</span><span class="p">([</span><span class="nx">id</span><span class="p">]);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Creates a module mapping that includes plugin prefix, module<br />name, and path. If parentModuleMap is provided it will<br />also normalize the name via require.normalize()</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>name </span><span class="dox_type">String</span><span>- the module name</span></div><div class="dox_tag_detail"><span>[parentModuleMap] </span><span class="dox_type">String</span><span>- parent module map</span></div><div class="dox_tag_detail"><span>isNormalized: </span><span class="dox_type">Boolean</span><span>- is the ID already normalized.</span></div><div class="dox_tag_detail"><span>applyMap: </span><span class="dox_type">Boolean</span><span>- apply the map config to the ID.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">parentModuleMap</span><span class="p">,</span> <span class="nx">isNormalized</span><span class="p">,</span> <span class="nx">applyMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">name</span> <span class="o">?</span> <span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="nx">prefix</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nx">parentName</span> <span class="o">=</span> <span class="nx">parentModuleMap</span> <span class="o">?</span> <span class="nx">parentModuleMap</span><span class="p">.</span><span class="nx">name</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nx">originalName</span> <span class="o">=</span> <span class="nx">name</span><span class="p">,</span>
                <span class="nx">isDefine</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">normalizedName</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">pluginModule</span><span class="p">,</span> <span class="nx">suffix</span><span class="p">;</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><p>If no name, then it means it is a require call, generate an
internal name.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">isDefine</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;_@r&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">requireCounter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
                <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">parentName</span><span class="p">,</span> <span class="nx">applyMap</span><span class="p">);</span>
            <span class="p">}</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><p>Account for relative paths if there is a base name.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">pluginModule</span> <span class="o">=</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">prefix</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">pluginModule</span> <span class="o">&amp;&amp;</span> <span class="nx">pluginModule</span><span class="p">.</span><span class="nx">normalize</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a href="#section-34" class="pilcrow">&#182;</a></div><p>Plugin is loaded, use its normalize method.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">normalizedName</span> <span class="o">=</span> <span class="nx">pluginModule</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">parentName</span><span class="p">,</span> <span class="nx">applyMap</span><span class="p">);</span>
                        <span class="p">});</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">normalizedName</span> <span class="o">=</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">parentName</span><span class="p">,</span> <span class="nx">applyMap</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-35"><td class="docs"><div class="pilwrap"><a href="#section-35" class="pilcrow">&#182;</a></div><p>A regular module.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">normalizedName</span> <span class="o">=</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">parentName</span><span class="p">,</span> <span class="nx">applyMap</span><span class="p">);</span>

                    <span class="nx">url</span> <span class="o">=</span> <span class="nx">urlMap</span><span class="p">[</span><span class="nx">normalizedName</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-36"><td class="docs"><div class="pilwrap"><a href="#section-36" class="pilcrow">&#182;</a></div><p>Calculate url for the module, if it has a name.
Use name here since nameToUrl also calls normalize,
and for relative names that are outside the baseUrl
this causes havoc. Was thinking of just removing
parentModuleMap to avoid extra normalization, but
normalize() still does a dot removal because of
issue #142, so just pass in name here and redo
the normalization. Paths outside baseUrl are just
messy to support.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">url</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">nameToUrl</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">parentModuleMap</span><span class="p">);</span></pre></div></td></tr><tr id="section-37"><td class="docs"><div class="pilwrap"><a href="#section-37" class="pilcrow">&#182;</a></div><p>Store the URL mapping for later.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">urlMap</span><span class="p">[</span><span class="nx">normalizedName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div></td></tr><tr id="section-38"><td class="docs"><div class="pilwrap"><a href="#section-38" class="pilcrow">&#182;</a></div><p>If the id is a plugin id that cannot be determined if it needs
normalization, stamp it with a unique ID so two matching relative
ids that may conflict can be separate.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">suffix</span> <span class="o">=</span> <span class="nx">prefix</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">pluginModule</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isNormalized</span> <span class="o">?</span>
                     <span class="s1">&#39;_unnormalized&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">unnormalizedCounter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span>
                     <span class="s1">&#39;&#39;</span><span class="p">;</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="nx">prefix</span><span class="o">:</span> <span class="nx">prefix</span><span class="p">,</span>
                <span class="nx">name</span><span class="o">:</span> <span class="nx">normalizedName</span><span class="p">,</span>
                <span class="nx">parentMap</span><span class="o">:</span> <span class="nx">parentModuleMap</span><span class="p">,</span>
                <span class="nx">unnormalized</span><span class="o">:</span> <span class="o">!!</span><span class="nx">suffix</span><span class="p">,</span>
                <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span>
                <span class="nx">originalName</span><span class="o">:</span> <span class="nx">originalName</span><span class="p">,</span>
                <span class="nx">isDefine</span><span class="o">:</span> <span class="nx">isDefine</span><span class="p">,</span>
                <span class="nx">id</span><span class="o">:</span> <span class="p">(</span><span class="nx">prefix</span> <span class="o">?</span>
                    <span class="nx">prefix</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">normalizedName</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">:</span>
                    <span class="nx">normalizedName</span><span class="p">)</span> <span class="o">+</span> <span class="nx">suffix</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">getModule</span><span class="p">(</span><span class="nx">depMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">depMap</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                <span class="nx">mod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">mod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="nx">depMap</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">mod</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">on</span><span class="p">(</span><span class="nx">depMap</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">depMap</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                <span class="nx">mod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">hasProp</span><span class="p">(</span><span class="nx">defined</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="o">!</span><span class="nx">mod</span> <span class="o">||</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">defineEmitComplete</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;defined&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">fn</span><span class="p">(</span><span class="nx">defined</span><span class="p">[</span><span class="nx">id</span><span class="p">]);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">getModule</span><span class="p">(</span><span class="nx">depMap</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">errback</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ids</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">requireModules</span><span class="p">,</span>
                <span class="nx">notified</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">errback</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">errback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">each</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">mod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-39"><td class="docs"><div class="pilwrap"><a href="#section-39" class="pilcrow">&#182;</a></div><p>Set error on module, so it skips timeout checks.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">mod</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">notified</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                            <span class="nx">mod</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">});</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">notified</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">req</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-40"><td class="docs"><div class="pilwrap"><a href="#section-40" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Internal method to transfer globalQueue items to this context's<br />defQueue.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">takeGlobalQueue</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr><tr id="section-41"><td class="docs"><div class="pilwrap"><a href="#section-41" class="pilcrow">&#182;</a></div><p>Push all the globalDefQueue items into the context's defQueue</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">globalDefQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-42"><td class="docs"><div class="pilwrap"><a href="#section-42" class="pilcrow">&#182;</a></div><p>Array splice in the values since the context code has a
local var ref to defQueue, so cannot just reassign the one
on context.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">apsp</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">defQueue</span><span class="p">,</span>
                           <span class="p">[</span><span class="nx">defQueue</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">globalDefQueue</span><span class="p">));</span>
                <span class="nx">globalDefQueue</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-43"><td class="docs"><div class="pilwrap"><a href="#section-43" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Helper function that creates a require function object to give to<br />modules that ask for it as a dependency. It needs to be specific<br />per module because of the implication of path mappings that may<br />need to be relative to the module name.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">makeRequire</span><span class="p">(</span><span class="nx">mod</span><span class="p">,</span> <span class="nx">enableBuildCallback</span><span class="p">,</span> <span class="nx">altRequire</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">relMap</span> <span class="o">=</span> <span class="nx">mod</span> <span class="o">&amp;&amp;</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span>
                <span class="nx">modRequire</span> <span class="o">=</span> <span class="nx">makeContextModuleFunc</span><span class="p">(</span><span class="nx">altRequire</span> <span class="o">||</span> <span class="nx">context</span><span class="p">.</span><span class="nx">require</span><span class="p">,</span>
                                                   <span class="nx">relMap</span><span class="p">,</span>
                                                   <span class="nx">enableBuildCallback</span><span class="p">);</span>

            <span class="nx">addRequireMethods</span><span class="p">(</span><span class="nx">modRequire</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">);</span>

            <span class="k">return</span> <span class="nx">modRequire</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;require&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">makeRequire</span><span class="p">(</span><span class="nx">mod</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="s1">&#39;exports&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">mod</span><span class="p">.</span><span class="nx">usingExports</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">isDefine</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{});</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;module&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">module</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">id</span><span class="o">:</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                    <span class="nx">uri</span><span class="o">:</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
                    <span class="nx">config</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">config</span> <span class="o">&amp;&amp;</span> <span class="nx">config</span><span class="p">.</span><span class="nx">config</span><span class="p">[</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">])</span> <span class="o">||</span> <span class="p">{};</span>
                    <span class="p">},</span>
                    <span class="nx">exports</span><span class="o">:</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">removeWaiting</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-44"><td class="docs"><div class="pilwrap"><a href="#section-44" class="pilcrow">&#182;</a></div><p>Clean up machinery used for waiting modules.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">delete</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

            <span class="nx">each</span><span class="p">(</span><span class="nx">waitAry</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">waitAry</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">defined</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">context</span><span class="p">.</span><span class="nx">waitCount</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">findCycle</span><span class="p">(</span><span class="nx">mod</span><span class="p">,</span> <span class="nx">traced</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                <span class="nx">depArray</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">,</span>
                <span class="nx">foundModule</span><span class="p">;</span></pre></div></td></tr><tr id="section-45"><td class="docs"><div class="pilwrap"><a href="#section-45" class="pilcrow">&#182;</a></div><p>Do not bother with unitialized modules or not yet enabled
modules.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">inited</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span></pre></div></td></tr><tr id="section-46"><td class="docs"><div class="pilwrap"><a href="#section-46" class="pilcrow">&#182;</a></div><p>Found the cycle.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">traced</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">mod</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">traced</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div></td></tr><tr id="section-47"><td class="docs"><div class="pilwrap"><a href="#section-47" class="pilcrow">&#182;</a></div><p>Trace through the dependencies.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">each</span><span class="p">(</span><span class="nx">depArray</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">depMap</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">depId</span> <span class="o">=</span> <span class="nx">depMap</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                    <span class="nx">depMod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">depId</span><span class="p">];</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">depMod</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">depMod</span><span class="p">.</span><span class="nx">inited</span> <span class="o">||</span> <span class="o">!</span><span class="nx">depMod</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-48"><td class="docs"><div class="pilwrap"><a href="#section-48" class="pilcrow">&#182;</a></div><p>Dependency is not inited, so this cannot
be used to determine a cycle.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">foundModule</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                    <span class="k">delete</span> <span class="nx">traced</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="p">(</span><span class="nx">foundModule</span> <span class="o">=</span> <span class="nx">findCycle</span><span class="p">(</span><span class="nx">depMod</span><span class="p">,</span> <span class="nx">traced</span><span class="p">));</span>
            <span class="p">});</span>

            <span class="k">return</span> <span class="nx">foundModule</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">forceExec</span><span class="p">(</span><span class="nx">mod</span><span class="p">,</span> <span class="nx">traced</span><span class="p">,</span> <span class="nx">uninited</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                <span class="nx">depArray</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">inited</span> <span class="o">||</span> <span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">isDefine</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">traced</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
            <span class="p">}</span>

            <span class="nx">traced</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">;</span>

            <span class="nx">each</span><span class="p">(</span><span class="nx">depArray</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">depMap</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">depId</span> <span class="o">=</span> <span class="nx">depMap</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                    <span class="nx">depMod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">depId</span><span class="p">],</span>
                    <span class="nx">value</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">depId</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">depMod</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">depMod</span><span class="p">.</span><span class="nx">inited</span> <span class="o">||</span> <span class="o">!</span><span class="nx">depMod</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-49"><td class="docs"><div class="pilwrap"><a href="#section-49" class="pilcrow">&#182;</a></div><p>Dependency is not inited,
so this module cannot be
given a forced value yet.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">uninited</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span></pre></div></td></tr><tr id="section-50"><td class="docs"><div class="pilwrap"><a href="#section-50" class="pilcrow">&#182;</a></div><p>Get the value for the current dependency</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">forceExec</span><span class="p">(</span><span class="nx">depMod</span><span class="p">,</span> <span class="nx">traced</span><span class="p">,</span> <span class="nx">uninited</span><span class="p">);</span></pre></div></td></tr><tr id="section-51"><td class="docs"><div class="pilwrap"><a href="#section-51" class="pilcrow">&#182;</a></div><p>Even with forcing it may not be done,
in particular if the module is waiting
on a plugin resource.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">uninited</span><span class="p">[</span><span class="nx">depId</span><span class="p">])</span> <span class="p">{</span>
                        <span class="nx">mod</span><span class="p">.</span><span class="nx">defineDepById</span><span class="p">(</span><span class="nx">depId</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">});</span>

            <span class="nx">mod</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

            <span class="k">return</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">modCheck</span><span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">mod</span><span class="p">.</span><span class="nx">check</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">checkLoaded</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">waitInterval</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">waitSeconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span></pre></div></td></tr><tr id="section-52"><td class="docs"><div class="pilwrap"><a href="#section-52" class="pilcrow">&#182;</a></div><p>It is possible to disable the wait interval by using waitSeconds of 0.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">expired</span> <span class="o">=</span> <span class="nx">waitInterval</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">+</span> <span class="nx">waitInterval</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">(),</span>
                <span class="nx">noLoads</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="nx">stillLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">needCycleCheck</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">map</span><span class="p">,</span> <span class="nx">modId</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">usingPathFallback</span><span class="p">;</span></pre></div></td></tr><tr id="section-53"><td class="docs"><div class="pilwrap"><a href="#section-53" class="pilcrow">&#182;</a></div><p>Do not bother if this call was a result of a cycle break.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">inCheckLoaded</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">inCheckLoaded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div></td></tr><tr id="section-54"><td class="docs"><div class="pilwrap"><a href="#section-54" class="pilcrow">&#182;</a></div><p>Figure out the state of all the modules.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">eachProp</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">map</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>
                <span class="nx">modId</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span></pre></div></td></tr><tr id="section-55"><td class="docs"><div class="pilwrap"><a href="#section-55" class="pilcrow">&#182;</a></div><p>Skip things that are not enabled or in error state.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-56"><td class="docs"><div class="pilwrap"><a href="#section-56" class="pilcrow">&#182;</a></div><p>If the module should be executed, and it has not
been inited and time is up, remember it.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">inited</span> <span class="o">&amp;&amp;</span> <span class="nx">expired</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">hasPathFallback</span><span class="p">(</span><span class="nx">modId</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nx">usingPathFallback</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                            <span class="nx">stillLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">noLoads</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">modId</span><span class="p">);</span>
                            <span class="nx">removeScript</span><span class="p">(</span><span class="nx">modId</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">inited</span> <span class="o">&amp;&amp;</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">fetched</span> <span class="o">&amp;&amp;</span> <span class="nx">map</span><span class="p">.</span><span class="nx">isDefine</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">stillLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">map</span><span class="p">.</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-57"><td class="docs"><div class="pilwrap"><a href="#section-57" class="pilcrow">&#182;</a></div><p>No reason to keep looking for unfinished
loading. If the only stillLoading is a
plugin resource though, keep going,
because it may be that a plugin resource
is waiting on a non-plugin cycle.</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="k">return</span> <span class="p">(</span><span class="nx">needCycleCheck</span> <span class="o">=</span> <span class="kc">false</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">});</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">expired</span> <span class="o">&amp;&amp;</span> <span class="nx">noLoads</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-58"><td class="docs"><div class="pilwrap"><a href="#section-58" class="pilcrow">&#182;</a></div><p>If wait time expired, throw error of unloaded modules.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">err</span> <span class="o">=</span> <span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;Load timeout for modules: &#39;</span> <span class="o">+</span> <span class="nx">noLoads</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">noLoads</span><span class="p">);</span>
                <span class="nx">err</span><span class="p">.</span><span class="nx">contextName</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">contextName</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span></pre></div></td></tr><tr id="section-59"><td class="docs"><div class="pilwrap"><a href="#section-59" class="pilcrow">&#182;</a></div><p>Not expired, check for a cycle.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">needCycleCheck</span><span class="p">)</span> <span class="p">{</span>

                <span class="nx">each</span><span class="p">(</span><span class="nx">waitAry</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">defined</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="kd">var</span> <span class="nx">cycleMod</span> <span class="o">=</span> <span class="nx">findCycle</span><span class="p">(</span><span class="nx">mod</span><span class="p">,</span> <span class="p">{}),</span>
                        <span class="nx">traced</span> <span class="o">=</span> <span class="p">{};</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">cycleMod</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">forceExec</span><span class="p">(</span><span class="nx">cycleMod</span><span class="p">,</span> <span class="nx">traced</span><span class="p">,</span> <span class="p">{});</span></pre></div></td></tr><tr id="section-60"><td class="docs"><div class="pilwrap"><a href="#section-60" class="pilcrow">&#182;</a></div><p>traced modules may have been
removed from the registry, but
their listeners still need to
be called.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">eachProp</span><span class="p">(</span><span class="nx">traced</span><span class="p">,</span> <span class="nx">modCheck</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">});</span></pre></div></td></tr><tr id="section-61"><td class="docs"><div class="pilwrap"><a href="#section-61" class="pilcrow">&#182;</a></div><p>Now that dependencies have
been satisfied, trigger the
completion check that then
notifies listeners.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">eachProp</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">modCheck</span><span class="p">);</span>
            <span class="p">}</span></pre></div></td></tr><tr id="section-62"><td class="docs"><div class="pilwrap"><a href="#section-62" class="pilcrow">&#182;</a></div><p>If still waiting on loads, and the waiting load is something
other than a plugin resource, or there are still outstanding
scripts, then just try back later.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="nx">expired</span> <span class="o">||</span> <span class="nx">usingPathFallback</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">stillLoading</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-63"><td class="docs"><div class="pilwrap"><a href="#section-63" class="pilcrow">&#182;</a></div><p>Something is still waiting to load. Wait for it, but only
if a timeout is not already in effect.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">((</span><span class="nx">isBrowser</span> <span class="o">||</span> <span class="nx">isWebWorker</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">checkLoadedTimeoutId</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">checkLoadedTimeoutId</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="nx">checkLoadedTimeoutId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="nx">checkLoaded</span><span class="p">();</span>
                    <span class="p">},</span> <span class="mi">50</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="nx">inCheckLoaded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">Module</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="o">=</span> <span class="nx">undefEvents</span><span class="p">[</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">||</span> <span class="p">{};</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="nx">map</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">shim</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">shim</span><span class="p">[</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">depExports</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">depMatched</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">pluginMaps</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">depCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-64"><td class="docs"><div class="pilwrap"><a href="#section-64" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>this.exports this.factory<br />               this.depMaps = [],<br />               this.enabled, this.fetched</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>        <span class="p">};</span>

        <span class="nx">Module</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">depMaps</span><span class="p">,</span> <span class="nx">factory</span><span class="p">,</span> <span class="nx">errback</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-65"><td class="docs"><div class="pilwrap"><a href="#section-65" class="pilcrow">&#182;</a></div><p>Do not do more inits if already done. Can happen if there
are multiple define calls for the same module. That is not
a normal, common case, but it is also not unexpected.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inited</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">factory</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">errback</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-66"><td class="docs"><div class="pilwrap"><a href="#section-66" class="pilcrow">&#182;</a></div><p>Register for errors on this module.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">errback</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-67"><td class="docs"><div class="pilwrap"><a href="#section-67" class="pilcrow">&#182;</a></div><p>If no errback already, but there are error listeners
on this module, set up an errback to pass to the deps.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">errback</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
                    <span class="p">});</span>
                <span class="p">}</span>

                <span class="nx">each</span><span class="p">(</span><span class="nx">depMaps</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">depMap</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">depMap</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">depMap</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">depMap</span><span class="p">,</span>
                                               <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">isDefine</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">parentMap</span><span class="p">),</span>
                                               <span class="kc">false</span><span class="p">,</span>
                                               <span class="kc">true</span><span class="p">);</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">depMap</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="nx">handlers</span><span class="p">[</span><span class="nx">depMap</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">depExports</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">this</span><span class="p">.</span><span class="nx">depCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

                    <span class="nx">on</span><span class="p">(</span><span class="nx">depMap</span><span class="p">,</span> <span class="s1">&#39;defined&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">depExports</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">defineDep</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">depExports</span><span class="p">);</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">check</span><span class="p">();</span>
                    <span class="p">}));</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">errback</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">on</span><span class="p">(</span><span class="nx">depMap</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">errback</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}));</span></pre></div></td></tr><tr id="section-68"><td class="docs"><div class="pilwrap"><a href="#section-68" class="pilcrow">&#182;</a></div><p>Indicate this module has be initialized</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">inited</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">ignore</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ignore</span><span class="p">;</span></pre></div></td></tr><tr id="section-69"><td class="docs"><div class="pilwrap"><a href="#section-69" class="pilcrow">&#182;</a></div><p>Could have option to init this module in enabled mode,
or could have been previously marked as enabled. However,
the dependencies are not known until init is called. So
if enabled previously, now trigger dependencies as enabled.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-70"><td class="docs"><div class="pilwrap"><a href="#section-70" class="pilcrow">&#182;</a></div><p>Enable this module and dependencies.
Will call this.check()</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">this</span><span class="p">.</span><span class="nx">enable</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">check</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">defineDepById</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">depExports</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span></pre></div></td></tr><tr id="section-71"><td class="docs"><div class="pilwrap"><a href="#section-71" class="pilcrow">&#182;</a></div><p>Find the index for this dependency.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">i</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">});</span>

                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">defineDep</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">depExports</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">defineDep</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">depExports</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-72"><td class="docs"><div class="pilwrap"><a href="#section-72" class="pilcrow">&#182;</a></div><p>Because of cycles, defined callback for a given
export can be called more than once.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">depMatched</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">depMatched</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">depCount</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">depExports</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">depExports</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fetched</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">fetched</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="nx">context</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">();</span>

                <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span></pre></div></td></tr><tr id="section-73"><td class="docs"><div class="pilwrap"><a href="#section-73" class="pilcrow">&#182;</a></div><p>If the manager is for a plugin managed resource,
ask the plugin to load it now.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">callPlugin</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shim</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">makeRequire</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kc">true</span><span class="p">)(</span><span class="k">this</span><span class="p">.</span><span class="nx">shim</span><span class="p">.</span><span class="nx">deps</span> <span class="o">||</span> <span class="p">[],</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">load</span><span class="p">();</span>
                    <span class="p">}));</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-74"><td class="docs"><div class="pilwrap"><a href="#section-74" class="pilcrow">&#182;</a></div><p>Regular dependency.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">this</span><span class="p">.</span><span class="nx">load</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">load</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span></pre></div></td></tr><tr id="section-75"><td class="docs"><div class="pilwrap"><a href="#section-75" class="pilcrow">&#182;</a></div><p>Regular dependency.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">urlFetched</span><span class="p">[</span><span class="nx">url</span><span class="p">])</span> <span class="p">{</span>
                    <span class="nx">urlFetched</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="nx">context</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span></pre></div></td></tr><tr id="section-76"><td class="docs"><div class="pilwrap"><a href="#section-76" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Checks is the module is ready to define itself, and if so,<br />define it. If the silent argument is true, then it will just<br />define, but not notify listeners, and not ask for a context-wide<br />check of all loaded modules. That is useful for cycle breaking.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">check</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">silent</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                    <span class="nx">depExports</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">depExports</span><span class="p">,</span>
                    <span class="nx">exports</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span>
                    <span class="nx">factory</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">factory</span><span class="p">,</span>
                    <span class="nx">err</span><span class="p">,</span> <span class="nx">cjsModule</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">inited</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">defining</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-77"><td class="docs"><div class="pilwrap"><a href="#section-77" class="pilcrow">&#182;</a></div><p>The factory could trigger another require call
that would result in checking this module to
define itself again. If already in the process
of doing that, skip this work.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">this</span><span class="p">.</span><span class="nx">defining</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">depCount</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">defined</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">factory</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-78"><td class="docs"><div class="pilwrap"><a href="#section-78" class="pilcrow">&#182;</a></div><p>If there is an error listener, favor passing
to that instead of throwing an error.</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">try</span> <span class="p">{</span>
                                    <span class="nx">exports</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">execCb</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">factory</span><span class="p">,</span> <span class="nx">depExports</span><span class="p">,</span> <span class="nx">exports</span><span class="p">);</span>
                                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="nx">err</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="nx">exports</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">execCb</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">factory</span><span class="p">,</span> <span class="nx">depExports</span><span class="p">,</span> <span class="nx">exports</span><span class="p">);</span>
                            <span class="p">}</span>

                            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">isDefine</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-79"><td class="docs"><div class="pilwrap"><a href="#section-79" class="pilcrow">&#182;</a></div><p>If setting exports via 'module' is in play,
favor that over return value and exports. After that,
favor a non-undefined return value over exports use.</p>
</td><td class="code"><div class="highlight"><pre>                                <span class="nx">cjsModule</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">module</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">cjsModule</span> <span class="o">&amp;&amp;</span>
                                    <span class="nx">cjsModule</span><span class="p">.</span><span class="nx">exports</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-80"><td class="docs"><div class="pilwrap"><a href="#section-80" class="pilcrow">&#182;</a></div><p>Make sure it is not already the exports value</p>
</td><td class="code"><div class="highlight"><pre>                                    <span class="nx">cjsModule</span><span class="p">.</span><span class="nx">exports</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="nx">exports</span> <span class="o">=</span> <span class="nx">cjsModule</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">usingExports</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-81"><td class="docs"><div class="pilwrap"><a href="#section-81" class="pilcrow">&#182;</a></div><p>exports already set the defined value.</p>
</td><td class="code"><div class="highlight"><pre>                                    <span class="nx">exports</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>

                            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">err</span><span class="p">.</span><span class="nx">requireMap</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>
                                <span class="nx">err</span><span class="p">.</span><span class="nx">requireModules</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
                                <span class="nx">err</span><span class="p">.</span><span class="nx">requireType</span> <span class="o">=</span> <span class="s1">&#39;define&#39;</span><span class="p">;</span>
                                <span class="k">return</span> <span class="nx">onError</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">err</span><span class="p">));</span>
                            <span class="p">}</span>

                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-82"><td class="docs"><div class="pilwrap"><a href="#section-82" class="pilcrow">&#182;</a></div><p>Just a literal value</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="nx">exports</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="k">this</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">isDefine</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ignore</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">defined</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span>

                            <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">onResourceLoad</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">req</span><span class="p">.</span><span class="nx">onResourceLoad</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">}</span></pre></div></td></tr><tr id="section-83"><td class="docs"><div class="pilwrap"><a href="#section-83" class="pilcrow">&#182;</a></div><p>Clean up</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">delete</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

                        <span class="k">this</span><span class="p">.</span><span class="nx">defined</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="nx">context</span><span class="p">.</span><span class="nx">waitCount</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">waitCount</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-84"><td class="docs"><div class="pilwrap"><a href="#section-84" class="pilcrow">&#182;</a></div><p>Clear the wait array used for cycles.</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="nx">waitAry</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="p">}</span>
                    <span class="p">}</span></pre></div></td></tr><tr id="section-85"><td class="docs"><div class="pilwrap"><a href="#section-85" class="pilcrow">&#182;</a></div><p>Finished the define stage. Allow calling check again
to allow define notifications below in the case of a
cycle.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">this</span><span class="p">.</span><span class="nx">defining</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">silent</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">defined</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">defineEmitted</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">defineEmitted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;defined&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">);</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">defineEmitComplete</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">callPlugin</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span>
                    <span class="nx">id</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                    <span class="nx">pluginMap</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">prefix</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

                <span class="nx">on</span><span class="p">(</span><span class="nx">pluginMap</span><span class="p">,</span> <span class="s1">&#39;defined&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">plugin</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                        <span class="nx">parentName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">parentMap</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">parentMap</span><span class="p">.</span><span class="nx">name</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                        <span class="nx">load</span><span class="p">,</span> <span class="nx">normalizedMap</span><span class="p">,</span> <span class="nx">normalizedMod</span><span class="p">;</span></pre></div></td></tr><tr id="section-86"><td class="docs"><div class="pilwrap"><a href="#section-86" class="pilcrow">&#182;</a></div><p>If current map is not normalized, wait for that
normalized name to load instead of continuing.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">unnormalized</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-87"><td class="docs"><div class="pilwrap"><a href="#section-87" class="pilcrow">&#182;</a></div><p>Normalize the ID if the plugin allows it.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="nx">plugin</span><span class="p">.</span><span class="nx">normalize</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">name</span> <span class="o">=</span> <span class="nx">plugin</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">return</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">parentName</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                            <span class="p">});</span>
                        <span class="p">}</span>

                        <span class="nx">normalizedMap</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">);</span>
                        <span class="nx">on</span><span class="p">(</span><span class="nx">normalizedMap</span><span class="p">,</span>
                           <span class="s1">&#39;defined&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">([],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">value</span><span class="p">;</span> <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
                                <span class="nx">enabled</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                                <span class="nx">ignore</span><span class="o">:</span> <span class="kc">true</span>
                            <span class="p">});</span>
                        <span class="p">}));</span>
                        <span class="nx">normalizedMod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">normalizedMap</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">normalizedMod</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">normalizedMod</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
                                <span class="p">}));</span>
                            <span class="p">}</span>
                            <span class="nx">normalizedMod</span><span class="p">.</span><span class="nx">enable</span><span class="p">();</span>
                        <span class="p">}</span>

                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="nx">load</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">([],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">value</span><span class="p">;</span> <span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
                            <span class="nx">enabled</span><span class="o">:</span> <span class="kc">true</span>
                        <span class="p">});</span>
                    <span class="p">});</span>

                    <span class="nx">load</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">inited</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
                        <span class="nx">err</span><span class="p">.</span><span class="nx">requireModules</span> <span class="o">=</span> <span class="p">[</span><span class="nx">id</span><span class="p">];</span></pre></div></td></tr><tr id="section-88"><td class="docs"><div class="pilwrap"><a href="#section-88" class="pilcrow">&#182;</a></div><p>Remove temp unnormalized modules for this module,
since they will never be resolved otherwise now.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">eachProp</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;_unnormalized&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">removeWaiting</span><span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">});</span>

                        <span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                    <span class="p">});</span></pre></div></td></tr><tr id="section-89"><td class="docs"><div class="pilwrap"><a href="#section-89" class="pilcrow">&#182;</a></div><p>Allow plugins to load other code without having to know the
context or how to 'complete' the load.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">load</span><span class="p">.</span><span class="nx">fromText</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-90"><td class="docs"><div class="pilwrap"><a href="#section-90" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>slint evil: true</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>                        <span class="kd">var</span> <span class="nx">hasInteractive</span> <span class="o">=</span> <span class="nx">useInteractive</span><span class="p">;</span></pre></div></td></tr><tr id="section-91"><td class="docs"><div class="pilwrap"><a href="#section-91" class="pilcrow">&#182;</a></div><p>Turn off interactive script matching for IE for any define
calls in the text, then turn it back on at the end.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="nx">hasInteractive</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">useInteractive</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="nx">req</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">hasInteractive</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">useInteractive</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">}</span></pre></div></td></tr><tr id="section-92"><td class="docs"><div class="pilwrap"><a href="#section-92" class="pilcrow">&#182;</a></div><p>Support anonymous modules.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">context</span><span class="p">.</span><span class="nx">completeLoad</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">);</span>
                    <span class="p">};</span></pre></div></td></tr><tr id="section-93"><td class="docs"><div class="pilwrap"><a href="#section-93" class="pilcrow">&#182;</a></div><p>Use parentName here since the plugin's name is not reliable,
could be some weird string with no path that actually wants to
reference the parentName's path.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">plugin</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">makeRequire</span><span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">parentMap</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">deps</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="nx">deps</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
                    <span class="p">}),</span> <span class="nx">load</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
                <span class="p">}));</span>

                <span class="nx">context</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">pluginMap</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">pluginMaps</span><span class="p">[</span><span class="nx">pluginMap</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pluginMap</span><span class="p">;</span>
            <span class="p">},</span>

            <span class="nx">enable</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">waitPushed</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">waitAry</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                    <span class="nx">context</span><span class="p">.</span><span class="nx">waitCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">waitPushed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                <span class="p">}</span></pre></div></td></tr><tr id="section-94"><td class="docs"><div class="pilwrap"><a href="#section-94" class="pilcrow">&#182;</a></div><p>Enable each dependency</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">depMaps</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                        <span class="nx">mod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span></pre></div></td></tr><tr id="section-95"><td class="docs"><div class="pilwrap"><a href="#section-95" class="pilcrow">&#182;</a></div><p>Skip special modules like 'require', 'exports', 'module'
Also, don't call enable if it is already enabled,
important in circular dependency cases.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">mod</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">context</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}));</span></pre></div></td></tr><tr id="section-96"><td class="docs"><div class="pilwrap"><a href="#section-96" class="pilcrow">&#182;</a></div><p>Enable each plugin that is used in
a dependency</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">eachProp</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pluginMaps</span><span class="p">,</span> <span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pluginMap</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">mod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">pluginMap</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">context</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">pluginMap</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}));</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">check</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">on</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">cbs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cbs</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">cbs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="p">}</span>
                <span class="nx">cbs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">emit</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">name</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">cb</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
                <span class="p">});</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-97"><td class="docs"><div class="pilwrap"><a href="#section-97" class="pilcrow">&#182;</a></div><p>Now that the error handler was triggered, remove
the listeners, since this broken Module instance
can stay around for a while in the registry/waitAry.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">function</span> <span class="nx">callGetModule</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">getModule</span><span class="p">(</span><span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">)).</span><span class="nx">init</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">removeListener</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">ieName</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-98"><td class="docs"><div class="pilwrap"><a href="#section-98" class="pilcrow">&#182;</a></div><p>Favor detachEvent because of IE9
issue, see attachEvent/addEventListener comment elsewhere
in this file.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">detachEvent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isOpera</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-99"><td class="docs"><div class="pilwrap"><a href="#section-99" class="pilcrow">&#182;</a></div><p>Probably IE. If not it will throw an error, which will be
useful to know.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">ieName</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">node</span><span class="p">.</span><span class="nx">detachEvent</span><span class="p">(</span><span class="nx">ieName</span><span class="p">,</span> <span class="nx">func</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-100"><td class="docs"><div class="pilwrap"><a href="#section-100" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Given an event from a script node, get the requirejs info from it,<br />and then removes the event listeners on the node.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>evt </span><span class="dox_type">Event</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">getScriptData</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-101"><td class="docs"><div class="pilwrap"><a href="#section-101" class="pilcrow">&#182;</a></div><p>Using currentTarget instead of target for Firefox 2.0's sake. Not
all old browsers will be supported, but this one was easy enough
to support and still makes sense.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">currentTarget</span> <span class="o">||</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">srcElement</span><span class="p">;</span></pre></div></td></tr><tr id="section-102"><td class="docs"><div class="pilwrap"><a href="#section-102" class="pilcrow">&#182;</a></div><p>Remove the listeners once here.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">removeListener</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">onScriptLoad</span><span class="p">,</span> <span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="s1">&#39;onreadystatechange&#39;</span><span class="p">);</span>
            <span class="nx">removeListener</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">onScriptError</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="nx">node</span><span class="o">:</span> <span class="nx">node</span><span class="p">,</span>
                <span class="nx">id</span><span class="o">:</span> <span class="nx">node</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-requiremodule&#39;</span><span class="p">)</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">(</span><span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">config</span><span class="o">:</span> <span class="nx">config</span><span class="p">,</span>
            <span class="nx">contextName</span><span class="o">:</span> <span class="nx">contextName</span><span class="p">,</span>
            <span class="nx">registry</span><span class="o">:</span> <span class="nx">registry</span><span class="p">,</span>
            <span class="nx">defined</span><span class="o">:</span> <span class="nx">defined</span><span class="p">,</span>
            <span class="nx">urlMap</span><span class="o">:</span> <span class="nx">urlMap</span><span class="p">,</span>
            <span class="nx">urlFetched</span><span class="o">:</span> <span class="nx">urlFetched</span><span class="p">,</span>
            <span class="nx">waitCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">defQueue</span><span class="o">:</span> <span class="nx">defQueue</span><span class="p">,</span>
            <span class="nx">Module</span><span class="o">:</span> <span class="nx">Module</span><span class="p">,</span>
            <span class="nx">makeModuleMap</span><span class="o">:</span> <span class="nx">makeModuleMap</span><span class="p">,</span></pre></div></td></tr><tr id="section-103"><td class="docs"><div class="pilwrap"><a href="#section-103" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Set a configuration for the context.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>cfg </span><span class="dox_type">Object</span><span>- config object to integrate.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">configure</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-104"><td class="docs"><div class="pilwrap"><a href="#section-104" class="pilcrow">&#182;</a></div><p>Make sure the baseUrl ends in a slash.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">cfg</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span></pre></div></td></tr><tr id="section-105"><td class="docs"><div class="pilwrap"><a href="#section-105" class="pilcrow">&#182;</a></div><p>Save off the paths and packages since they require special processing,
they are additive.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">paths</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">paths</span><span class="p">,</span>
                    <span class="nx">pkgs</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">pkgs</span><span class="p">,</span>
                    <span class="nx">shim</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">shim</span><span class="p">,</span>
                    <span class="nx">map</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">map</span> <span class="o">||</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-106"><td class="docs"><div class="pilwrap"><a href="#section-106" class="pilcrow">&#182;</a></div><p>Mix in the config values, favoring the new values over
existing ones in context.config.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">mixin</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span></pre></div></td></tr><tr id="section-107"><td class="docs"><div class="pilwrap"><a href="#section-107" class="pilcrow">&#182;</a></div><p>Merge paths.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">mixin</span><span class="p">(</span><span class="nx">paths</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">paths</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="nx">config</span><span class="p">.</span><span class="nx">paths</span> <span class="o">=</span> <span class="nx">paths</span><span class="p">;</span></pre></div></td></tr><tr id="section-108"><td class="docs"><div class="pilwrap"><a href="#section-108" class="pilcrow">&#182;</a></div><p>Merge map</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">mixin</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                    <span class="nx">config</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="nx">map</span><span class="p">;</span>
                <span class="p">}</span></pre></div></td></tr><tr id="section-109"><td class="docs"><div class="pilwrap"><a href="#section-109" class="pilcrow">&#182;</a></div><p>Merge shim</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">shim</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">eachProp</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">shim</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-110"><td class="docs"><div class="pilwrap"><a href="#section-110" class="pilcrow">&#182;</a></div><p>Normalize the structure</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nx">value</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="nx">deps</span><span class="o">:</span> <span class="nx">value</span>
                            <span class="p">};</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">exports</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">value</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">__buildReady</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">value</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">makeShimExports</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">exports</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="nx">shim</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                    <span class="p">});</span>
                    <span class="nx">config</span><span class="p">.</span><span class="nx">shim</span> <span class="o">=</span> <span class="nx">shim</span><span class="p">;</span>
                <span class="p">}</span></pre></div></td></tr><tr id="section-111"><td class="docs"><div class="pilwrap"><a href="#section-111" class="pilcrow">&#182;</a></div><p>Adjust packages if necessary.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">packages</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">each</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">packages</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pkgObj</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">location</span><span class="p">;</span>

                        <span class="nx">pkgObj</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">pkgObj</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">?</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">pkgObj</span> <span class="p">}</span> <span class="o">:</span> <span class="nx">pkgObj</span><span class="p">;</span>
                        <span class="nx">location</span> <span class="o">=</span> <span class="nx">pkgObj</span><span class="p">.</span><span class="nx">location</span><span class="p">;</span></pre></div></td></tr><tr id="section-112"><td class="docs"><div class="pilwrap"><a href="#section-112" class="pilcrow">&#182;</a></div><p>Create a brand new object on pkgs, since currentPackages can
be passed in again, and config.pkgs is the internal transformed
state for all package configs.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">pkgs</span><span class="p">[</span><span class="nx">pkgObj</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="nx">name</span><span class="o">:</span> <span class="nx">pkgObj</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                            <span class="nx">location</span><span class="o">:</span> <span class="nx">location</span> <span class="o">||</span> <span class="nx">pkgObj</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span></pre></div></td></tr><tr id="section-113"><td class="docs"><div class="pilwrap"><a href="#section-113" class="pilcrow">&#182;</a></div><p>Remove leading dot in main, so main paths are normalized,
and remove any trailing .js, since different package
envs have different conventions: some use a module name,
some use a file name.</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="nx">main</span><span class="o">:</span> <span class="p">(</span><span class="nx">pkgObj</span><span class="p">.</span><span class="nx">main</span> <span class="o">||</span> <span class="s1">&#39;main&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">currDirRegExp</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">jsSuffixRegExp</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="p">};</span>
                    <span class="p">});</span></pre></div></td></tr><tr id="section-114"><td class="docs"><div class="pilwrap"><a href="#section-114" class="pilcrow">&#182;</a></div><p>Done with modifications, assing packages back to context config</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">config</span><span class="p">.</span><span class="nx">pkgs</span> <span class="o">=</span> <span class="nx">pkgs</span><span class="p">;</span>
                <span class="p">}</span></pre></div></td></tr><tr id="section-115"><td class="docs"><div class="pilwrap"><a href="#section-115" class="pilcrow">&#182;</a></div><p>If a deps array or a config callback is specified, then call
require with those args. This is useful when require is defined as a
config object before require.js is loaded.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">deps</span> <span class="o">||</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">context</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">deps</span> <span class="o">||</span> <span class="p">[],</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">makeShimExports</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">func</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">func</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">getGlobal</span><span class="p">(</span><span class="nx">exports</span><span class="p">);</span>
                    <span class="p">};</span></pre></div></td></tr><tr id="section-116"><td class="docs"><div class="pilwrap"><a href="#section-116" class="pilcrow">&#182;</a></div><p>Save the exports for use in nodefine checking.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">func</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span>
                    <span class="k">return</span> <span class="nx">func</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">global</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
                    <span class="p">};</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">requireDefined</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">hasProp</span><span class="p">(</span><span class="nx">defined</span><span class="p">,</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">id</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">requireSpecified</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">id</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">id</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">hasProp</span><span class="p">(</span><span class="nx">defined</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="o">||</span> <span class="nx">hasProp</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">require</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">moduleName</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">requireMod</span><span class="p">,</span> <span class="nx">args</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">deps</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-117"><td class="docs"><div class="pilwrap"><a href="#section-117" class="pilcrow">&#182;</a></div><p>Invalid call</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;requireargs&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid require call&#39;</span><span class="p">),</span> <span class="nx">errback</span><span class="p">);</span>
                    <span class="p">}</span></pre></div></td></tr><tr id="section-118"><td class="docs"><div class="pilwrap"><a href="#section-118" class="pilcrow">&#182;</a></div><p>Synchronous access to one module. If require.get is
available (as in the Node adapter), prefer that.
In this case deps is the moduleName and callback is
the relMap</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">get</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
                    <span class="p">}</span></pre></div></td></tr><tr id="section-119"><td class="docs"><div class="pilwrap"><a href="#section-119" class="pilcrow">&#182;</a></div><p>Just return the module wanted. In this scenario, the
second arg (if passed) is just the relMap.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">moduleName</span> <span class="o">=</span> <span class="nx">deps</span><span class="p">;</span>
                    <span class="nx">relMap</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span></pre></div></td></tr><tr id="section-120"><td class="docs"><div class="pilwrap"><a href="#section-120" class="pilcrow">&#182;</a></div><p>Normalize module name, if it contains . or ..</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">map</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                    <span class="nx">id</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasProp</span><span class="p">(</span><span class="nx">defined</span><span class="p">,</span> <span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;notloaded&#39;</span><span class="p">,</span> <span class="s1">&#39;Module name &quot;&#39;</span> <span class="o">+</span>
                                    <span class="nx">id</span> <span class="o">+</span>
                                    <span class="s1">&#39;&quot; has not been loaded yet for context: &#39;</span> <span class="o">+</span>
                                    <span class="nx">contextName</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
                <span class="p">}</span></pre></div></td></tr><tr id="section-121"><td class="docs"><div class="pilwrap"><a href="#section-121" class="pilcrow">&#182;</a></div><p>Callback require. Normalize args. if callback or errback is
not a function, it means it is a relMap. Test errback first.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">errback</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">errback</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">relMap</span> <span class="o">=</span> <span class="nx">errback</span><span class="p">;</span>
                    <span class="nx">errback</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">relMap</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
                    <span class="nx">callback</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
                <span class="p">}</span></pre></div></td></tr><tr id="section-122"><td class="docs"><div class="pilwrap"><a href="#section-122" class="pilcrow">&#182;</a></div><p>Any defined modules in the global queue, intake them now.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">takeGlobalQueue</span><span class="p">();</span></pre></div></td></tr><tr id="section-123"><td class="docs"><div class="pilwrap"><a href="#section-123" class="pilcrow">&#182;</a></div><p>Make sure any remaining defQueue items get properly processed.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">while</span> <span class="p">(</span><span class="nx">defQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">args</span> <span class="o">=</span> <span class="nx">defQueue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;mismatch&#39;</span><span class="p">,</span> <span class="s1">&#39;Mismatched anonymous define() module: &#39;</span> <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]));</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-124"><td class="docs"><div class="pilwrap"><a href="#section-124" class="pilcrow">&#182;</a></div><p>args are id, deps, factory. Should be normalized by the
define() function.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">callGetModule</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span></pre></div></td></tr><tr id="section-125"><td class="docs"><div class="pilwrap"><a href="#section-125" class="pilcrow">&#182;</a></div><p>Mark all the dependencies as needing to be loaded.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">requireMod</span> <span class="o">=</span> <span class="nx">getModule</span><span class="p">(</span><span class="nx">makeModuleMap</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">relMap</span><span class="p">));</span>

                <span class="nx">requireMod</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">enabled</span><span class="o">:</span> <span class="kc">true</span>
                <span class="p">});</span>

                <span class="nx">checkLoaded</span><span class="p">();</span>

                <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">require</span><span class="p">;</span>
            <span class="p">},</span>

            <span class="nx">undef</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">makeModuleMap</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span>
                    <span class="nx">mod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

                <span class="k">delete</span> <span class="nx">defined</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
                <span class="k">delete</span> <span class="nx">urlMap</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
                <span class="k">delete</span> <span class="nx">urlFetched</span><span class="p">[</span><span class="nx">map</span><span class="p">.</span><span class="nx">url</span><span class="p">];</span>
                <span class="k">delete</span> <span class="nx">undefEvents</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-126"><td class="docs"><div class="pilwrap"><a href="#section-126" class="pilcrow">&#182;</a></div><p>Hold on to listeners in case the
module will be attempted to be reloaded
using a different config.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">defined</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">undefEvents</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mod</span><span class="p">.</span><span class="nx">events</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="nx">removeWaiting</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span></pre></div></td></tr><tr id="section-127"><td class="docs"><div class="pilwrap"><a href="#section-127" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Called to enable a module if it is still in the registry<br />awaiting enablement. parent module is passed in for context,<br />used by the optimizer.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">enable</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">depMap</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">mod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">depMap</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">getModule</span><span class="p">(</span><span class="nx">depMap</span><span class="p">).</span><span class="nx">enable</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">},</span></pre></div></td></tr><tr id="section-128"><td class="docs"><div class="pilwrap"><a href="#section-128" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Internal method used by environment adapters to complete a load event.<br />A load event could be a script load or just a load pass from a synchronous<br />load call.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>moduleName </span><span class="dox_type">String</span><span>- the name of the module to potentially complete.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">completeLoad</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">moduleName</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">shim</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">shim</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">]</span> <span class="o">||</span> <span class="p">{},</span>
                <span class="nx">shExports</span> <span class="o">=</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">exports</span> <span class="o">&amp;&amp;</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span>
                <span class="nx">found</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">mod</span><span class="p">;</span>

                <span class="nx">takeGlobalQueue</span><span class="p">();</span>

                <span class="k">while</span> <span class="p">(</span><span class="nx">defQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">args</span> <span class="o">=</span> <span class="nx">defQueue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">moduleName</span><span class="p">;</span></pre></div></td></tr><tr id="section-129"><td class="docs"><div class="pilwrap"><a href="#section-129" class="pilcrow">&#182;</a></div><p>If already found an anonymous module and bound it
to this name, then this is some other anon module
waiting for its completeLoad to fire.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="nx">found</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">moduleName</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-130"><td class="docs"><div class="pilwrap"><a href="#section-130" class="pilcrow">&#182;</a></div><p>Found matching define call for this script!</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="nx">callGetModule</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
                <span class="p">}</span></pre></div></td></tr><tr id="section-131"><td class="docs"><div class="pilwrap"><a href="#section-131" class="pilcrow">&#182;</a></div><p>Do this after the cycle of callGetModule in case the result
of those calls/init calls changes the registry.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">mod</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">];</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">found</span> <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="nx">defined</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">mod</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">mod</span><span class="p">.</span><span class="nx">inited</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">enforceDefine</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">shExports</span> <span class="o">||</span> <span class="o">!</span><span class="nx">getGlobal</span><span class="p">(</span><span class="nx">shExports</span><span class="p">)))</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">hasPathFallback</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">))</span> <span class="p">{</span>
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;nodefine&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;No define call for &#39;</span> <span class="o">+</span> <span class="nx">moduleName</span><span class="p">,</span>
                                             <span class="kc">null</span><span class="p">,</span>
                                             <span class="p">[</span><span class="nx">moduleName</span><span class="p">]));</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-132"><td class="docs"><div class="pilwrap"><a href="#section-132" class="pilcrow">&#182;</a></div><p>A script that does not call define(), so just simulate
the call for it.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">callGetModule</span><span class="p">([</span><span class="nx">moduleName</span><span class="p">,</span> <span class="p">(</span><span class="nx">shim</span><span class="p">.</span><span class="nx">deps</span> <span class="o">||</span> <span class="p">[]),</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">exports</span><span class="p">]);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="nx">checkLoaded</span><span class="p">();</span>
            <span class="p">},</span></pre></div></td></tr><tr id="section-133"><td class="docs"><div class="pilwrap"><a href="#section-133" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Converts a module name + .extension into an URL path.<br /><em>Requires</em> the use of a module name. It does not support using<br />plain URLs like nameToUrl.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">toUrl</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">moduleNamePlusExt</span><span class="p">,</span> <span class="nx">relModuleMap</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">moduleNamePlusExt</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">),</span>
                    <span class="nx">ext</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">ext</span> <span class="o">=</span> <span class="nx">moduleNamePlusExt</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">moduleNamePlusExt</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
                    <span class="nx">moduleNamePlusExt</span> <span class="o">=</span> <span class="nx">moduleNamePlusExt</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">nameToUrl</span><span class="p">(</span><span class="nx">moduleNamePlusExt</span><span class="p">,</span> <span class="nx">ext</span><span class="p">,</span> <span class="nx">relModuleMap</span><span class="p">);</span>
            <span class="p">},</span></pre></div></td></tr><tr id="section-134"><td class="docs"><div class="pilwrap"><a href="#section-134" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Converts a module name to a file path. Supports cases where<br />moduleName may actually be just an URL.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">nameToUrl</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">ext</span><span class="p">,</span> <span class="nx">relModuleMap</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">paths</span><span class="p">,</span> <span class="nx">pkgs</span><span class="p">,</span> <span class="nx">pkg</span><span class="p">,</span> <span class="nx">pkgPath</span><span class="p">,</span> <span class="nx">syms</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">parentModule</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span>
                    <span class="nx">parentPath</span><span class="p">;</span></pre></div></td></tr><tr id="section-135"><td class="docs"><div class="pilwrap"><a href="#section-135" class="pilcrow">&#182;</a></div><p>Normalize module name if have a base relative module name to work from.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">moduleName</span> <span class="o">=</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">relModuleMap</span> <span class="o">&amp;&amp;</span> <span class="nx">relModuleMap</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span></pre></div></td></tr><tr id="section-136"><td class="docs"><div class="pilwrap"><a href="#section-136" class="pilcrow">&#182;</a></div><p>If a colon is in the URL, it indicates a protocol is used and it is just
an URL to a file, or if it starts with a slash, contains a query arg (i.e. ?)
or ends with .js, then assume the user meant to use an url and not a module id.
The slash is important for protocol-less URLs as well as full paths.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">jsExtRegExp</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-137"><td class="docs"><div class="pilwrap"><a href="#section-137" class="pilcrow">&#182;</a></div><p>Just a plain path, not module name lookup, so just return it.
Add extension if it is included. This is a bit wonky, only non-.js things pass
an extension, this method probably needs to be reworked.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">url</span> <span class="o">=</span> <span class="nx">moduleName</span> <span class="o">+</span> <span class="p">(</span><span class="nx">ext</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr id="section-138"><td class="docs"><div class="pilwrap"><a href="#section-138" class="pilcrow">&#182;</a></div><p>A module that needs to be converted to a path.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">paths</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">paths</span><span class="p">;</span>
                    <span class="nx">pkgs</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">pkgs</span><span class="p">;</span>

                    <span class="nx">syms</span> <span class="o">=</span> <span class="nx">moduleName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-139"><td class="docs"><div class="pilwrap"><a href="#section-139" class="pilcrow">&#182;</a></div><p>For each module name segment, see if there is a path
registered for it. Start with most specific name
and work up from it.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">syms</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">parentModule</span> <span class="o">=</span> <span class="nx">syms</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                        <span class="nx">pkg</span> <span class="o">=</span> <span class="nx">pkgs</span><span class="p">[</span><span class="nx">parentModule</span><span class="p">];</span>
                        <span class="nx">parentPath</span> <span class="o">=</span> <span class="nx">paths</span><span class="p">[</span><span class="nx">parentModule</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">parentPath</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-140"><td class="docs"><div class="pilwrap"><a href="#section-140" class="pilcrow">&#182;</a></div><p>If an array, it means there are a few choices,
Choose the one that is desired</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">parentPath</span><span class="p">))</span> <span class="p">{</span>
                                <span class="nx">parentPath</span> <span class="o">=</span> <span class="nx">parentPath</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                            <span class="p">}</span>
                            <span class="nx">syms</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">parentPath</span><span class="p">);</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pkg</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-141"><td class="docs"><div class="pilwrap"><a href="#section-141" class="pilcrow">&#182;</a></div><p>If module name is just the package name, then looking
for the main module.</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="k">if</span> <span class="p">(</span><span class="nx">moduleName</span> <span class="o">===</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">pkgPath</span> <span class="o">=</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">location</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">main</span><span class="p">;</span>
                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="nx">pkgPath</span> <span class="o">=</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">location</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="nx">syms</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">pkgPath</span><span class="p">);</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span></pre></div></td></tr><tr id="section-142"><td class="docs"><div class="pilwrap"><a href="#section-142" class="pilcrow">&#182;</a></div><p>Join the path parts together, then figure out if baseUrl is needed.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">url</span> <span class="o">=</span> <span class="nx">syms</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">ext</span> <span class="o">||</span> <span class="s1">&#39;.js&#39;</span><span class="p">);</span>
                    <span class="nx">url</span> <span class="o">=</span> <span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span> <span class="o">||</span> <span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[\w\+\.\-]+:/</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">)</span> <span class="o">+</span> <span class="nx">url</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="nx">config</span><span class="p">.</span><span class="nx">urlArgs</span> <span class="o">?</span> <span class="nx">url</span> <span class="o">+</span>
                                        <span class="p">((</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="s1">&#39;?&#39;</span> <span class="o">:</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">)</span> <span class="o">+</span>
                                         <span class="nx">config</span><span class="p">.</span><span class="nx">urlArgs</span><span class="p">)</span> <span class="o">:</span> <span class="nx">url</span><span class="p">;</span>
            <span class="p">},</span></pre></div></td></tr><tr id="section-143"><td class="docs"><div class="pilwrap"><a href="#section-143" class="pilcrow">&#182;</a></div><p>Delegates to req.load. Broken out as a separate function to
allow overriding in the optimizer.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">load</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
            <span class="p">},</span></pre></div></td></tr><tr id="section-144"><td class="docs"><div class="pilwrap"><a href="#section-144" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Executes a module callack function. Broken out as a separate function<br />solely to allow the build system to sequence the files in the built<br />layer in the right sequence.</p></div><div class="details"></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">execCb</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
            <span class="p">},</span></pre></div></td></tr><tr id="section-145"><td class="docs"><div class="pilwrap"><a href="#section-145" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>callback for script loads, used to check status of loading.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>evt </span><span class="dox_type">Event</span><span>- the event from the browser for the script</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">onScriptLoad</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-146"><td class="docs"><div class="pilwrap"><a href="#section-146" class="pilcrow">&#182;</a></div><p>Using currentTarget instead of target for Firefox 2.0's sake. Not
all old browsers will be supported, but this one was easy enough
to support and still makes sense.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;load&#39;</span> <span class="o">||</span>
                    <span class="p">(</span><span class="nx">readyRegExp</span><span class="p">.</span><span class="nx">test</span><span class="p">((</span><span class="nx">evt</span><span class="p">.</span><span class="nx">currentTarget</span> <span class="o">||</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">srcElement</span><span class="p">).</span><span class="nx">readyState</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-147"><td class="docs"><div class="pilwrap"><a href="#section-147" class="pilcrow">&#182;</a></div><p>Reset interactive script so a script node is not held onto for
to long.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">interactiveScript</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div></td></tr><tr id="section-148"><td class="docs"><div class="pilwrap"><a href="#section-148" class="pilcrow">&#182;</a></div><p>Pull out the name of the module and the context.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">getScriptData</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
                    <span class="nx">context</span><span class="p">.</span><span class="nx">completeLoad</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span></pre></div></td></tr><tr id="section-149"><td class="docs"><div class="pilwrap"><a href="#section-149" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Callback for script errors.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">onScriptError</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">getScriptData</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasPathFallback</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">makeError</span><span class="p">(</span><span class="s1">&#39;scripterror&#39;</span><span class="p">,</span> <span class="s1">&#39;Script error&#39;</span><span class="p">,</span> <span class="nx">evt</span><span class="p">,</span> <span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">]));</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-150"><td class="docs"><div class="pilwrap"><a href="#section-150" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Main entry point.</p></div><div class="body"><p>If the only argument to require is a string, then the module that<br />is represented by that string is fetched for the appropriate context.</p>

<p>If the first argument is an array, then it will be treated as an array<br />of dependency string names to fetch. An optional function callback can<br />be specified to execute when all of those dependencies are available.</p>

<p>Make a local req variable to help Caja compliance (it assumes things<br />on a require that are not standardized), and to give a short<br />name for minification/local scope use.</p></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">req</span> <span class="o">=</span> <span class="nx">requirejs</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">,</span> <span class="nx">optional</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-151"><td class="docs"><div class="pilwrap"><a href="#section-151" class="pilcrow">&#182;</a></div><p>Find the right context, use default</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">contextName</span> <span class="o">=</span> <span class="nx">defContextName</span><span class="p">,</span>
            <span class="nx">context</span><span class="p">,</span> <span class="nx">config</span><span class="p">;</span></pre></div></td></tr><tr id="section-152"><td class="docs"><div class="pilwrap"><a href="#section-152" class="pilcrow">&#182;</a></div><p>Determine if have config object in the call.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">deps</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">deps</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-153"><td class="docs"><div class="pilwrap"><a href="#section-153" class="pilcrow">&#182;</a></div><p>deps is a config object</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">config</span> <span class="o">=</span> <span class="nx">deps</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-154"><td class="docs"><div class="pilwrap"><a href="#section-154" class="pilcrow">&#182;</a></div><p>Adjust args if there are dependencies</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">deps</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
                <span class="nx">callback</span> <span class="o">=</span> <span class="nx">errback</span><span class="p">;</span>
                <span class="nx">errback</span> <span class="o">=</span> <span class="nx">optional</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">deps</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">config</span> <span class="o">&amp;&amp;</span> <span class="nx">config</span><span class="p">.</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">contextName</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">context</span> <span class="o">=</span> <span class="nx">contexts</span><span class="p">[</span><span class="nx">contextName</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">context</span> <span class="o">=</span> <span class="nx">contexts</span><span class="p">[</span><span class="nx">contextName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">newContext</span><span class="p">(</span><span class="nx">contextName</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">context</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-155"><td class="docs"><div class="pilwrap"><a href="#section-155" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Support require.config() to make it easier to cooperate with other<br />AMD loaders on globally agreed names.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">req</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">req</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-156"><td class="docs"><div class="pilwrap"><a href="#section-156" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Export require as a global, but only if it does not already exist.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">require</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">require</span> <span class="o">=</span> <span class="nx">req</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">req</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="nx">version</span><span class="p">;</span></pre></div></td></tr><tr id="section-157"><td class="docs"><div class="pilwrap"><a href="#section-157" class="pilcrow">&#182;</a></div><p>Used to filter out dependencies that are already paths.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">req</span><span class="p">.</span><span class="nx">jsExtRegExp</span> <span class="o">=</span> <span class="sr">/^\/|:|\?|\.js$/</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">isBrowser</span> <span class="o">=</span> <span class="nx">isBrowser</span><span class="p">;</span>
    <span class="nx">s</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">contexts</span><span class="o">:</span> <span class="nx">contexts</span><span class="p">,</span>
        <span class="nx">newContext</span><span class="o">:</span> <span class="nx">newContext</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-158"><td class="docs"><div class="pilwrap"><a href="#section-158" class="pilcrow">&#182;</a></div><p>Create default context.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">req</span><span class="p">({});</span></pre></div></td></tr><tr id="section-159"><td class="docs"><div class="pilwrap"><a href="#section-159" class="pilcrow">&#182;</a></div><p>Exports some context-sensitive methods on global require, using
default context if no context specified.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">addRequireMethods</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">contexts</span><span class="p">[</span><span class="nx">defContextName</span><span class="p">]);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isBrowser</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">head</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">head</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span></pre></div></td></tr><tr id="section-160"><td class="docs"><div class="pilwrap"><a href="#section-160" class="pilcrow">&#182;</a></div><p>If BASE tag is in play, using appendChild is a problem for IE6.
When that browser dies, this can be removed. Details in this jQuery bug:
http://dev.jquery.com/ticket/2709</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">baseElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">baseElement</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">head</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">head</span> <span class="o">=</span> <span class="nx">baseElement</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-161"><td class="docs"><div class="pilwrap"><a href="#section-161" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Any errors that require explicitly generates will be passed to this<br />function. Intercept/override it if you want custom error handling.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>err </span><span class="dox_type">Error</span><span>- the error object.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">req</span><span class="p">.</span><span class="nx">onError</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-162"><td class="docs"><div class="pilwrap"><a href="#section-162" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Does the request to load a module for the browser case.<br />Make this a separate function to allow other environments<br />to override it.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>context </span><span class="dox_type">Object</span><span>- the require context to find state.</span></div><div class="dox_tag_detail"><span>moduleName </span><span class="dox_type">String</span><span>- the name of the module.</span></div><div class="dox_tag_detail"><span>url </span><span class="dox_type">Object</span><span>- the URL to the module.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">req</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">moduleName</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">(</span><span class="nx">context</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span> <span class="o">||</span> <span class="p">{},</span>
            <span class="nx">node</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isBrowser</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-163"><td class="docs"><div class="pilwrap"><a href="#section-163" class="pilcrow">&#182;</a></div><p>In the browser so use a script tag</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">node</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">xhtml</span> <span class="o">?</span>
                   <span class="nb">document</span><span class="p">.</span><span class="nx">createElementNS</span><span class="p">(</span><span class="s1">&#39;http://www.w3.org/1999/xhtml&#39;</span><span class="p">,</span> <span class="s1">&#39;html:script&#39;</span><span class="p">)</span> <span class="o">:</span>
                   <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">scriptType</span> <span class="o">||</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">;</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">charset</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">;</span>

            <span class="nx">node</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;data-requirecontext&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">contextName</span><span class="p">);</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;data-requiremodule&#39;</span><span class="p">,</span> <span class="nx">moduleName</span><span class="p">);</span></pre></div></td></tr><tr id="section-164"><td class="docs"><div class="pilwrap"><a href="#section-164" class="pilcrow">&#182;</a></div><p>Set up load listener. Test attachEvent first because IE9 has
a subtle issue in its addEventListener and script onload firings
that do not match the behavior of all other browsers with
addEventListener support, which fire the onload event for a
script right after the script execution. See:
https://connect.microsoft.com/IE/feedback/details/648057/script-onload-event-is-not-fired-immediately-after-script-execution
UNFORTUNATELY Opera implements attachEvent but does not follow the script
script execution mode.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attachEvent</span> <span class="o">&amp;&amp;</span></pre></div></td></tr><tr id="section-165"><td class="docs"><div class="pilwrap"><a href="#section-165" class="pilcrow">&#182;</a></div><p>Check if node.attachEvent is artificially added by custom script or
natively supported by browser
read https://github.com/jrburke/requirejs/issues/187
if we can NOT find [native code] then it must NOT natively supported.
in IE8, node.attachEvent does not have toString()
Note the test for "[native code" with no closing brace, see:
https://github.com/jrburke/requirejs/issues/273</p>
</td><td class="code"><div class="highlight"><pre>                <span class="o">!</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">.</span><span class="nx">toString</span> <span class="o">&amp;&amp;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;[native code&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="nx">isOpera</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-166"><td class="docs"><div class="pilwrap"><a href="#section-166" class="pilcrow">&#182;</a></div><p>Probably IE. IE (at least 6-8) do not fire
script onload right after executing the script, so
we cannot tie the anonymous define call to a name.
However, IE reports the script as being in 'interactive'
readyState at the time of the define call.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">useInteractive</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="nx">node</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">&#39;onreadystatechange&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">onScriptLoad</span><span class="p">);</span></pre></div></td></tr><tr id="section-167"><td class="docs"><div class="pilwrap"><a href="#section-167" class="pilcrow">&#182;</a></div><p>It would be great to add an error handler here to catch
404s in IE9+. However, onreadystatechange will fire before
the error handler, so that does not help. If addEvenListener
is used, then IE will fire error before load, but we cannot
use that pathway given the connect.microsoft.com issue
mentioned above about not doing the 'script execute,
then fire the script load event listener before execute
next script' that other browsers do.
Best hope: IE10 fixes the issues,
and then destroys all installs of IE 6-9.
node.attachEvent('onerror', context.onScriptError);</p>
</td><td class="code"><div class="highlight"><pre>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">onScriptLoad</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
                <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">onScriptError</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">node</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span></pre></div></td></tr><tr id="section-168"><td class="docs"><div class="pilwrap"><a href="#section-168" class="pilcrow">&#182;</a></div><p>For some cache cases in IE 6-8, the script executes before the end
of the appendChild execution, so to tie an anonymous define
call to the module name (which is stored on the node), hold on
to a reference to this node, but clear after the DOM insertion.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">currentlyAddingScript</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">baseElement</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">head</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">baseElement</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">currentlyAddingScript</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

            <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isWebWorker</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-169"><td class="docs"><div class="pilwrap"><a href="#section-169" class="pilcrow">&#182;</a></div><p>In a web worker, use importScripts. This is not a very
efficient use of importScripts, importScripts will block until
its script is downloaded and evaluated. However, if web workers
are in play, the expectation that a build has been done so that
only one script needs to be loaded anyway. This may need to be
reevaluated if other use cases become common.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">importScripts</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span></pre></div></td></tr><tr id="section-170"><td class="docs"><div class="pilwrap"><a href="#section-170" class="pilcrow">&#182;</a></div><p>Account for anonymous modules</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">context</span><span class="p">.</span><span class="nx">completeLoad</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">getInteractiveScript</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">interactiveScript</span> <span class="o">&amp;&amp;</span> <span class="nx">interactiveScript</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">&#39;interactive&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">interactiveScript</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">eachReverse</span><span class="p">(</span><span class="nx">scripts</span><span class="p">(),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">&#39;interactive&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">interactiveScript</span> <span class="o">=</span> <span class="nx">script</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">interactiveScript</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-171"><td class="docs"><div class="pilwrap"><a href="#section-171" class="pilcrow">&#182;</a></div><p>Look for a data-main script attribute, which could also adjust the baseUrl.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">isBrowser</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-172"><td class="docs"><div class="pilwrap"><a href="#section-172" class="pilcrow">&#182;</a></div><p>Figure out baseUrl. Get it from the script tag with require.js in it.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">eachReverse</span><span class="p">(</span><span class="nx">scripts</span><span class="p">(),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-173"><td class="docs"><div class="pilwrap"><a href="#section-173" class="pilcrow">&#182;</a></div><p>Set the 'head' where we can append children by
using the script's parent.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">head</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">head</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
            <span class="p">}</span></pre></div></td></tr><tr id="section-174"><td class="docs"><div class="pilwrap"><a href="#section-174" class="pilcrow">&#182;</a></div><p>Look for a data-main attribute to set main script for the page
to load. If it is there, the path to data main becomes the
baseUrl, if it is not already set.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">dataMain</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-main&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">dataMain</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-175"><td class="docs"><div class="pilwrap"><a href="#section-175" class="pilcrow">&#182;</a></div><p>Pull off the directory of data-main for use as the
baseUrl.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">src</span> <span class="o">=</span> <span class="nx">dataMain</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                    <span class="nx">mainScript</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                    <span class="nx">subPath</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">src</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="s1">&#39;./&#39;</span><span class="p">;</span></pre></div></td></tr><tr id="section-176"><td class="docs"><div class="pilwrap"><a href="#section-176" class="pilcrow">&#182;</a></div><p>Set final config.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">cfg</span><span class="p">.</span><span class="nx">baseUrl</span> <span class="o">=</span> <span class="nx">subPath</span><span class="p">;</span></pre></div></td></tr><tr id="section-177"><td class="docs"><div class="pilwrap"><a href="#section-177" class="pilcrow">&#182;</a></div><p>Strip off any trailing .js since dataMain is now
like a module name.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">dataMain</span> <span class="o">=</span> <span class="nx">mainScript</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">jsSuffixRegExp</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
                <span class="p">}</span></pre></div></td></tr><tr id="section-178"><td class="docs"><div class="pilwrap"><a href="#section-178" class="pilcrow">&#182;</a></div><p>Put the data-main script in the files to load.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">cfg</span><span class="p">.</span><span class="nx">deps</span> <span class="o">=</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">deps</span> <span class="o">?</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">deps</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">dataMain</span><span class="p">)</span> <span class="o">:</span> <span class="p">[</span><span class="nx">dataMain</span><span class="p">];</span>

                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr><tr id="section-179"><td class="docs"><div class="pilwrap"><a href="#section-179" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>The function that handles definitions of modules. Differs from<br />require() in that a string for the module should be the first argument,<br />and the function to execute after dependencies are loaded should<br />return a value to define the module corresponding to the first argument's<br />name.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">define</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">context</span><span class="p">;</span></pre></div></td></tr><tr id="section-180"><td class="docs"><div class="pilwrap"><a href="#section-180" class="pilcrow">&#182;</a></div><p>Allow for anonymous functions</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">name</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-181"><td class="docs"><div class="pilwrap"><a href="#section-181" class="pilcrow">&#182;</a></div><p>Adjust args appropriately</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">callback</span> <span class="o">=</span> <span class="nx">deps</span><span class="p">;</span>
            <span class="nx">deps</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
            <span class="nx">name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-182"><td class="docs"><div class="pilwrap"><a href="#section-182" class="pilcrow">&#182;</a></div><p>This module may not have dependencies</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">deps</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">callback</span> <span class="o">=</span> <span class="nx">deps</span><span class="p">;</span>
            <span class="nx">deps</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-183"><td class="docs"><div class="pilwrap"><a href="#section-183" class="pilcrow">&#182;</a></div><p>If no name, and callback is a function, then figure out if it a
CommonJS thing with dependencies.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">deps</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">isFunction</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr><tr id="section-184"><td class="docs"><div class="pilwrap"><a href="#section-184" class="pilcrow">&#182;</a></div><p>Remove comments from the callback string,
look for require calls, and pull them into the dependencies,
but only if there are function args.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span>
                    <span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
                    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">commentRegExp</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">cjsRequireRegExp</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">deps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dep</span><span class="p">);</span>
                    <span class="p">});</span></pre></div></td></tr><tr id="section-185"><td class="docs"><div class="pilwrap"><a href="#section-185" class="pilcrow">&#182;</a></div><p>May be a CommonJS thing even without require calls, but still
could use exports, and module. Avoid doing exports and module
work though if it just needs require.
REQUIRES the function to expect the CommonJS variables in the
order listed below.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">deps</span> <span class="o">=</span> <span class="p">(</span><span class="nx">callback</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">?</span> <span class="p">[</span><span class="s1">&#39;require&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="s1">&#39;require&#39;</span><span class="p">,</span> <span class="s1">&#39;exports&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">]).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">deps</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-186"><td class="docs"><div class="pilwrap"><a href="#section-186" class="pilcrow">&#182;</a></div><p>If in IE 6-8 and hit an anonymous define() call, do the interactive
work.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">useInteractive</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">node</span> <span class="o">=</span> <span class="nx">currentlyAddingScript</span> <span class="o">||</span> <span class="nx">getInteractiveScript</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">name</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-requiremodule&#39;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">context</span> <span class="o">=</span> <span class="nx">contexts</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-requirecontext&#39;</span><span class="p">)];</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-187"><td class="docs"><div class="pilwrap"><a href="#section-187" class="pilcrow">&#182;</a></div><p>Always save off evaluating the def call until the script onload handler.
This allows multiple modules to be in a file without prematurely
tracing dependencies, and allows for anonymous module support,
where the module name is not known until the script onload event
occurs. If no context, use the global queue, and get it processed
in the onscript load callback.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="p">(</span><span class="nx">context</span> <span class="o">?</span> <span class="nx">context</span><span class="p">.</span><span class="nx">defQueue</span> <span class="o">:</span> <span class="nx">globalDefQueue</span><span class="p">).</span><span class="nx">push</span><span class="p">([</span><span class="nx">name</span><span class="p">,</span> <span class="nx">deps</span><span class="p">,</span> <span class="nx">callback</span><span class="p">]);</span>
    <span class="p">};</span>

    <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">jQuery</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-188"><td class="docs"><div class="pilwrap"><a href="#section-188" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Executes the text. Normally just uses eval, but can be modified<br />to use a better, environment-specific call. Only used for transpiling<br />loader plugins, not for plain JS modules.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span>text </span><span class="dox_type">String</span><span>- the text to execute/evaluate.</span></div></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">req</span><span class="p">.</span><span class="nx">exec</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-189"><td class="docs"><div class="pilwrap"><a href="#section-189" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>slint evil: true</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-190"><td class="docs"><div class="pilwrap"><a href="#section-190" class="pilcrow">&#182;</a></div><p>Set up with config info.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">req</span><span class="p">(</span><span class="nx">cfg</span><span class="p">);</span>
<span class="p">}(</span><span class="k">this</span><span class="p">));</span>

</pre></div></td></tr></tbody></table><div id="projectname"><a href="../../../index.html">JukeboxJS</a></div></div></body></html>